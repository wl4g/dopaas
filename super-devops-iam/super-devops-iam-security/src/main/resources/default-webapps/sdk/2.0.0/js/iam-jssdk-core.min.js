/**
 * Iam core v2.0.0 | (c) 2017 ~ 2050 wl4g Foundation, Inc.
 * Copyright 2017-2032 <wangsir@gmail.com, 983708408@qq.com>, Inc. x
 * Licensed under Apache2.0 (https://github.com/wl4g/super-devops/blob/master/LICENSE)
 */
(function(window,document){var constant={baseUriStoredKey:'__IAM_BASEURI',umidTokenStorageKey:'__IAM_UMIDTOKEN',useSecureAlgorithmName:'RSA',};var runtime={umid:{_value:null,getValue:function(){return Common.Util.checkEmpty("Fatal error, umidToken value is null, No attention to call order (must be executed after runtime.umid.getValuePromise())",runtime.umid._value)},_currentlyInGettingValuePromise:null,getValuePromise:function(){if(runtime.umid._currentlyInGettingValuePromise){return runtime.umid._currentlyInGettingValuePromise}var cacheUmidToken=Common.Util.Codec.decodeBase58(sessionStorage.getItem(constant.umidTokenStorageKey));if(!Common.Util.isEmpty(cacheUmidToken)){runtime.umid._value=cacheUmidToken;return new Promise((reslove,reject)=>reslove(cacheUmidToken))}return(runtime.umid._currentlyInGettingValuePromise=new Promise((reslove,reject)=>{Common.Util.getFingerprint({},function(fpObj){var umItem=new Map();umItem.set("userAgent",fpObj.components.get("userAgent"));umItem.set("platform",fpObj.components.get("platform"));umItem.set("pixelRatio",fpObj.components.get("pixelRatio"));umItem.set("timezone",fpObj.components.get("timezone"));umItem.set("language",fpObj.components.get("language"));umItem.set("cpuClass",fpObj.components.get("cpuClass"));umItem.set("touchSupport",fpObj.components.get("touchSupport"));umItem.set("deviceMemory",fpObj.components.get("deviceMemory"));umItem.set("availableScreenResolution",fpObj.components.get("availableScreenResolution"));umItem.set("canvas",CryptoJS.MD5(fpObj.components.get("canvas")).toString(CryptoJS.enc.Hex));umItem.set("webgl",CryptoJS.MD5(fpObj.components.get("webgl")).toString(CryptoJS.enc.Hex));umItem.set("indexedDb",fpObj.components.get("indexedDb"));umItem.set("sessionStorage",fpObj.components.get("sessionStorage"));umItem.set("localStorage",fpObj.components.get("localStorage"));umItem.set("colorDepth",fpObj.components.get("colorDepth"));var umidParam=new Map();var umItemData=Common.Util.toUrl({},umItem);var n=100+parseInt(Math.random()*100);var iterations=parseInt(n%3+1),umdata=umItemData;for(var i=0;i<iterations;i++){umdata=Common.Util.Codec.encodeBase58(umdata)}umdata=n+"!"+umdata;console.debug("Generated apply umidToken data: "+umdata);umidParam.set("umdata",umdata);doIamRequest("post","{applyUmTokenUri}",umidParam,function(res){Common.Util.checkEmpty("init.onPostUmidToken",settings.init.onPostUmidToken)(res);var codeOkValue=Common.Util.checkEmpty("definition.codeOkValue",settings.definition.codeOkValue);if(!Common.Util.isEmpty(res)&&(res.code==codeOkValue)){console.debug("Got umidToken: "+res.data.umidToken);var encodeUmidToken=Common.Util.Codec.encodeBase58(res.data.umidToken);sessionStorage.setItem(constant.umidTokenStorageKey,encodeUmidToken);reslove(res.data.umidToken);runtime.umid._value=res.data.umidToken;runtime.umid._currentlyInGettingValuePromise=null}},function(errmsg){console.warn("Failed to gets umidToken, "+errmsg);Common.Util.checkEmpty("init.onError",settings.init.onError)(errmsg);reject(errmsg)},false)})}))},},handshake:{_value:null,getValue:function(){return Common.Util.checkEmpty("Fatal error, handshake value is null, No attention to call order (must be executed after runtime.handshake.getValuePromise())",runtime.handshake._value)},_currentlyInGettingValuePromise:null,getValuePromise:function(umidToken){if(runtime.handshake._currentlyInGettingValuePromise){return runtime.handshake._currentlyInGettingValuePromise}if(!Common.Util.isEmpty(runtime.handshake._value)){return new Promise((reslove,reject)=>reslove(runtime.handshake._value))}return(runtime.handshake._currentlyInGettingValuePromise=new Promise((reslove,reject)=>{var handshakeParam=new Map();handshakeParam.set("{umidTokenKey}",Common.Util.checkEmpty("umidToken",umidToken));doIamRequest("post","{handshakeUri}",handshakeParam,function(res){var codeOkValue=Common.Util.checkEmpty("definition.codeOkValue",settings.definition.codeOkValue);if(!Common.Util.isEmpty(res)&&(res.code==codeOkValue)){runtime.handshake._value=$.extend(true,runtime.handshake._value,res.data);reslove(runtime.handshake._value)}},function(errmsg){console.log("Failed to handshake, "+errmsg);Common.Util.checkEmpty("init.onError",settings.init.onError)(errmsg)},false)}))},handleSessionTo:function(param){if(!Common.Util.isAnyEmpty(runtime.handshake._value.session.sk,runtime.handshake._value.session.sv)){if(Common.Util.isObject(param)){param[runtime.handshake._value.session.sk]=runtime.handshake._value.session.sv}else if(Common.Util.isMap(param)){param.set(runtime.handshake._value.session.sk,runtime.handshake._value.session.sv)}}},handleChooseSecureAlg:function(){var _algs=runtime.handshake.getValue().algs;for(index in _algs){var alg=Common.Util.Codec.decodeBase58(_algs[index]);if(alg.startsWith(constant.useSecureAlgorithmName)){return _algs[index]}}throw Error('No such secure algoritm of: '+constant.useSecureAlgorithmName);},},safeCheck:{checkGeneric:{secretKey:null,},checkCaptcha:{enabled:false,support:null,applyUri:null,},checkSms:{enabled:false,mobileNum:null,remainDelayMs:null,}},clientSecretKey:{},applyModel:{primaryImg:null,applyToken:null,verifyType:null,},verifiedModel:{verified:true,verifiedToken:null,},flags:{isCurrentlyApplying:false,isVerifying:false,}};var _defaultCaptchaVerifier={captchaLen:5,captchaDestroy:function(destroy){var imgInput=Common.Util.checkEmpty("captcha.input",settings.captcha.input);var img=Common.Util.checkEmpty("captcha.img",settings.captcha.img);$(img).unbind("click");$(img).attr({"src":"./static/images/ok.png"});$(imgInput).attr('disabled',true);$(imgInput).css({"cursor":"context-menu"});if(destroy){$(imgInput).val("");$(imgInput).css({"display":"none"});$(img).attr({"src":""});$(img).css({"display":"none"})}},captchaRender:function(){runtime.flags.isCurrentlyApplying=false;var imgInput=$(Common.Util.checkEmpty("captcha.input",settings.captcha.input));var img=Common.Util.checkEmpty("captcha.img",settings.captcha.img);imgInput.val("");$(img).click(function(){resetCaptcha()});doIamRequest("get",getApplyCaptchaUrl(),new Map(),function(res){runtime.flags.isCurrentlyApplying=false;runtime.applyModel=res.data.applyModel;$(imgInput).css({"display":"none","cursor":"text"});$(imgInput).removeAttr('disabled');$(img).css({"display":"none"});var codeOkValue=Common.Util.checkEmpty("definition.codeOkValue",settings.definition.codeOkValue);if(!Common.Util.isEmpty(res)&&res.code==codeOkValue){$(img).attr("src",res.data.applyModel.primaryImg)}else{$(img).attr("title",res.message);$(img).unbind("click");setTimeout(function(){$(img).click(function(){resetCaptcha()})},15000)}},function(req,status,errmsg){console.debug("Failed to apply captcha, "+errmsg);Common.Util.checkEmpty("captcha.onError",settings.captcha.onError)(errmsg)},true)}};var settings={definition:{responseType:"response_type",responseTypeValue:"json",whichKey:"which",redirectUrlKey:"redirect_url",refreshUrlKey:"refresh_url",principalKey:"principal",credentialKey:"credential",clientSecretKey:"clientSecretKey",verifyTypeKey:"verifyType",applyTokenKey:"applyToken",verifyDataKey:"verifyData",verifiedTokenKey:"verifiedToken",clientRefKey:"client_ref",umidTokenKey:"umidToken",secureAlgKey:"alg",smsActionKey:"action",smsActionValueLogin:"login",applyUmTokenUri:"/rcm/applyumtoken",handshakeUri:"/login/handshake",checkUri:"/login/check",captchaApplyUri:"/verify/applycaptcha",verifyAnalyzeUri:"/verify/verifyanalysis",accountSubmitUri:"/auth/generic",smsApplyUri:"/verify/applysmsverify",smsSubmitUri:"/auth/sms",snsConnectUri:"/sns/connect/",codeOkValue:"200"},deploy:{baseUri:null,defaultTwoDomain:"iam",defaultContextPath:"/iam-server",},init:{onPostUmidToken:function(res){console.debug("onPostUmidToken... "+res)},onPreCheck:function(principal,checkUrl){console.debug("onPostCheck... principal:"+principal+", checkUrl:"+checkUrl);return true},onPostCheck:function(res){console.debug("onPostCheck... "+res)},onError:function(errmsg){console.error("Failed to initialize... "+errmsg)}},captcha:{enable:false,use:"VerifyWithGifGraph",panel:null,img:null,input:null,getVerifier:function(){var _type=Common.Util.checkEmpty("captcha.use",settings.captcha.use);var _registry=Common.Util.checkEmpty("captcha.registry",settings.captcha.registry);for(var type in _registry){if(type==_type){return _registry[type]}}throw"Illegal verifier type for '"+type+"'";},registry:{VerifyWithSimpleGraph:_defaultCaptchaVerifier,VerifyWithGifGraph:_defaultCaptchaVerifier,VerifyWithJigsawGraph:{captchaDestroy:function(destroy){var jigsawPanel=Common.Util.checkEmpty("captcha.panel",settings.captcha.panel);if(destroy){$(jigsawPanel).css({"display":"none"})}},captchaRender:function(){runtime.flags.isCurrentlyApplying=false;var jigsawPanel=Common.Util.checkEmpty("captcha.panel",settings.captcha.panel);$(jigsawPanel).JigsawIamCaptcha({verifyDataKey:Common.Util.checkEmpty("definition.verifyDataKey",settings.definition.verifyDataKey),getApplyCaptchaUrl:getApplyCaptchaUrl,getVerifyAnalysisUrl:getVerifyAnalysisUrl,repeatIcon:'fa fa-redo',onSuccess:function(verifiedToken){console.debug("Jigsaw captcha verify successful. verifiedToken is '"+verifiedToken+"'");runtime.flags.isCurrentlyApplying=false;runtime.verifiedModel.verifiedToken=verifiedToken;Common.Util.checkEmpty("captcha.onSuccess",settings.captcha.onSuccess)(verifiedToken)},onFail:function(element){console.debug("Failed to jigsaw captcha verify. element => "+element);runtime.flags.isCurrentlyApplying=false;runtime.verifiedModel.verifiedToken="";Common.Util.checkEmpty("captcha.onError",settings.captcha.onError)(element)}})},},},onSuccess:function(verifiedToken){console.debug("Jigsaw captcha verify successfully. verifiedToken is '"+verifiedToken+"'")},onError:function(errmsg){console.error("Failed to jigsaw captcha verify. "+errmsg)}},account:{enable:false,submitBtn:null,principal:null,credential:null,onBeforeSubmit:function(principal,credentials,verifiedToken){console.debug("Prepare to submit login request. principal="+principal+", verifiedToken="+verifiedToken);return true},onSuccess:function(principal,redirectUrl){console.info("Sign in successfully. "+principal+", "+redirectUrl);return true},onError:function(errmsg){console.error("Sign in error. "+errmsg)}},sms:{enable:false,submitBtn:null,sendSmsBtn:null,mobileArea:null,mobile:null,onBeforeSubmit:function(mobileNum,smsCode){console.log("Prepare to submit SMS login request. mobileNum="+mobileNum+", smsCode="+smsCode);return true},onSuccess:function(resp){console.log("SMS success. "+resp.message)},onError:function(errmsg){throw"SMS login error. "+errmsg;}},sns:{enable:false,required:{getWhich:function(provider,panelType){throw"Unsupported errors, please implement to support get which function";},refreshUrl:null},getPrincipal:function(){},qrcodePanel:null,pagePanel:null,provider:null,onBefore:function(provider,panelType,connectUrl){}}};var _initConfigure=function(obj){settings=$.extend(true,settings,obj);console.debug("Default iamBaseURI: "+settings.deploy.baseUri);if(Common.Util.isEmpty(settings.deploy.baseUri)){var hostname=location.hostname;var pathname=location.pathname;var twoDomain=settings.deploy.defaultTwoDomain;var contextPath=settings.deploy.defaultContextPath;contextPath=contextPath.startsWith("/")?contextPath:("/"+contextPath);var port=location.port;var protocol=location.protocol;if(hostname=='localhost'||hostname=='127.0.0.1'||Common.Util.isIp(hostname)||hostname.endsWith('.debug')||hostname.endsWith('.local')||hostname.endsWith('.dev')){settings.deploy.baseUri=protocol+"//"+hostname+":14040"+contextPath}else{var topDomainName=hostname.split('.').slice(-2).join('.');if(hostname.indexOf("com.cn")>0){topDomainName=hostname.split('.').slice(-3).join('.')}settings.deploy.baseUri=protocol+"//"+twoDomain+"."+topDomainName+contextPath}}window.sessionStorage.setItem(constant.baseUriStoredKey,settings.deploy.baseUri);console.debug("Using overlay iamBaseURI: "+settings.deploy.baseUri)};var getSnsConnectUrl=function(provider,panelType){var required=Common.Util.checkEmpty("sns.required",settings.sns.required);var which=Common.Util.checkEmpty("required.getWhich",required.getWhich(provider,panelType));var url=settings.deploy.baseUri+Common.Util.checkEmpty("definition.snsConnectUri",settings.definition.snsConnectUri)+Common.Util.checkEmpty("provider",provider)+"?"+Common.Util.checkEmpty("definition.whichKey",settings.definition.whichKey)+"="+which;if(which.toLowerCase()=="bind"||which.toLowerCase()=="unbind"){var principal=encodeURIComponent(Common.Util.checkEmpty("sns.principal",settings.sns.getPrincipal()));var refreshUrl=encodeURIComponent(Common.Util.checkEmpty("sns.required.refreshUrl",settings.sns.required.refreshUrl));url+="&"+Common.Util.checkEmpty("definition.principalKey",settings.definition.principalKey)+"="+principal;url+="&"+Common.Util.checkEmpty("definition.refreshUrlKey",settings.definition.refreshUrlKey)+"="+refreshUrl}if(panelType=="pagePanel"){url+="&agent=y"}else if(panelType=="qrcodePanel"){url+="&agent=n"}return url};var getApplyCaptchaUrl=function(){var paramMap=new Map();paramMap.set(Common.Util.checkEmpty("definition.umidTokenKey",settings.definition.umidTokenKey),runtime.umid.getValue());paramMap.set(Common.Util.checkEmpty("definition.verifyTypeKey",settings.definition.verifyTypeKey),Common.Util.checkEmpty("captcha.use",settings.captcha.use));paramMap.set(Common.Util.checkEmpty("definition.responseType",settings.definition.responseType),Common.Util.checkEmpty("definition.responseTypeValue",settings.definition.responseTypeValue));runtime.handshake.handleSessionTo(paramMap);paramMap.set("r",Math.random());return Common.Util.checkEmpty("checkCaptcha.applyUri",runtime.safeCheck.checkCaptcha.applyUri)+"?"+Common.Util.toUrl({},paramMap)};var getVerifyAnalysisUrl=function(){var paramMap=new Map();paramMap.set(Common.Util.checkEmpty("definition.umidTokenKey",settings.definition.umidTokenKey),runtime.umid.getUmidToken());paramMap.set(Common.Util.checkEmpty("definition.verifyTypeKey",settings.definition.verifyTypeKey),Common.Util.checkEmpty("captcha.use",settings.captcha.use));paramMap.set(Common.Util.checkEmpty("definition.responseType",settings.definition.responseType),Common.Util.checkEmpty("definition.responseTypeValue",settings.definition.responseTypeValue));paramMap.set("r",Math.random());runtime.handshake.handleSessionTo(paramMap);return Common.Util.checkEmpty("deploy.baseUri",settings.deploy.baseUri)+Common.Util.checkEmpty("definition.verifyAnalyzeUri",settings.definition.verifyAnalyzeUri)+"?"+Common.Util.toUrl({},paramMap)};var resetCaptcha=function(){_InitSafeCheck(function(checkCaptcha,checkGeneric,checkSms){if(checkCaptcha.enabled&&!runtime.flags.isCurrentlyApplying){Common.Util.checkEmpty("captcha.getVerifier",settings.captcha.getVerifier)().captchaRender()}})};var snsViewReader=function(connectUrl,panelType){if("qrcodePanel"==panelType){var qrcodeIframeId="iam_qrcode_panel_iframe";var qrcodeIframe=document.querySelector('#'+qrcodeIframeId);if(qrcodeIframe==null||qrcodeIframe.length<=0){var qrcodePanel=Common.Util.checkEmpty("sns.qrcodePanel",settings.sns.qrcodePanel);var qrcodePanelSrc=Common.Util.checkEmpty("qrcodePanel.src",qrcodePanel.src);var qrcodePanelW=qrcodePanel.width||"250";var qrcodePanelH=qrcodePanel.height||"260";qrcodeIframe=document.createElement("iframe");qrcodeIframe.setAttribute("id",qrcodeIframeId);qrcodeIframe.setAttribute("frameborder","1");qrcodeIframe.setAttribute("scrolling","no");qrcodeIframe.setAttribute("width",qrcodePanelW);qrcodeIframe.setAttribute("height",qrcodePanelH);qrcodeIframe.setAttribute("style","border:solid 0;");qrcodePanelSrc.appendChild(qrcodeIframe)}setTimeout(function(){var qrcodeIframe=document.querySelector('#'+qrcodeIframeId);if(-1==navigator.userAgent.indexOf("MSIE")){qrcodeIframe.src=connectUrl}else{qrcodeIframe.location=connectUrl}},2)}else if("pagePanel"==panelType){var pagePanel=Common.Util.checkEmpty("sns.pagePanel",settings.sns.pagePanel);var modal=pagePanel.modal||"yes";var width=pagePanel.width||"800px";var height=pagePanel.height||"500px";var left=pagePanel.left||"250px";var top=pagePanel.top||"100px";var resizable=pagePanel.resizable||"no";var oauth2ChildWindow=window.open(connectUrl,window,"modal="+modal+",width="+width+",height="+height+",resizable="+resizable+",left="+left+",top="+top);var monitor=setInterval(function(){var refreshUrl=window.document.getElementsByTagName("body")[0].getAttribute("refreshUrl");if(oauth2ChildWindow!=null&&oauth2ChildWindow.closed){clearInterval(monitor);if(!Common.Util.isEmpty(refreshUrl)){Common.Util.getRootWindow(window).location.href=refreshUrl}}},200)}else{throw"Unsupported panelType, use 'qrcodePanel' or 'pagePanel'";}};var _InitSNSAuthenticator=function(){if(!settings.sns.enable){console.warn("SNS authenticator not enable!");return}var providerMap=Common.Util.checkEmpty("sns.provider",settings.sns.provider);for(var provider in providerMap){var providerValue=providerMap[provider];var src=Common.Util.checkEmpty(provider+".src",providerValue.src);var panelType=Common.Util.checkEmpty(provider+".panelType",providerValue.panelType);src.setAttribute("provider",provider);src.setAttribute("panelType",panelType);src.onclick=function(event){var curProviderEle=event.srcElement;var provider=curProviderEle.getAttribute("provider");var panelType=curProviderEle.getAttribute("panelType");var connectUrl=getSnsConnectUrl(provider,panelType);if(!settings.sns.onBefore(provider,panelType,connectUrl)){console.warn("onBefore has blocked execution");return this}snsViewReader(connectUrl,panelType)}}};var _InitSafeCheck=function(callback){$(function(){var principal=encodeURIComponent(Common.Util.getEleValue("account.principal",settings.account.principal,false));if(!Common.Util.checkEmpty("init.onPreCheck",settings.init.onPreCheck)(principal)){console.warn("Skip the init safeCheck, because onPreCheck() return false");return}var checkParam=new Map();checkParam.set("{principalKey}",principal);checkParam.set("{verifyTypeKey}",Common.Util.checkEmpty("captcha.use",settings.captcha.use));checkParam.set("{umidTokenKey}",runtime.umid.getValue());checkParam.set("{secureAlgKey}",runtime.handshake.handleChooseSecureAlg());doIamRequest("post","{checkUri}",checkParam,function(res){Common.Util.checkEmpty("init.onPostCheck",settings.init.onPostCheck)(res);var codeOkValue=Common.Util.checkEmpty("definition.codeOkValue",settings.definition.codeOkValue);if(!Common.Util.isEmpty(res)&&(res.code==codeOkValue)){runtime.safeCheck=$.extend(true,runtime.safeCheck,res.data);callback(res.data.checkCaptcha,res.data.checkGeneric,res.data.checkSms)}},function(errmsg){console.log("Failed to safe check, "+errmsg);Common.Util.checkEmpty("init.onError",settings.init.onError)(errmsg)},true)})};var _InitCaptchaVerifier=function(){if(!settings.captcha.enable){console.warn("Captcha verifier not enable!");return}$(function(){resetCaptcha();if(settings.captcha.use=="VerifyWithSimpleGraph"||settings.captcha.use=="VerifyWithGifGraph"){var imgInput=$(Common.Util.checkEmpty("captcha.input",settings.captcha.input));imgInput.attr("maxlength",Common.Util.checkEmpty("captcha.getVerifier",settings.captcha.getVerifier)().captchaLen);imgInput.keyup(function(){if(runtime.safeCheck.checkCaptcha.enabled){var captcha=imgInput.val();if(!Common.Util.isEmpty(captcha)&&captcha.length>=parseInt(imgInput.attr("maxlength"))&&!runtime.flags.isVerifying){runtime.flags.isVerifying=true;var _check=function(name,params){return Common.Util.checkEmpty(name,params)};var captchaParam=new Map();captchaParam.put("{verifyDataKey}",captcha);captchaParam.put("{applyTokenKey}",_check("applyModel.applyToken",runtime.applyModel.applyToken));captchaParam.put("{verifyTypeKey}",_check("applyModel.verifyType",runtime.applyModel.verifyType));captchaParam.set("{umidTokenKey}",runtime.umid.getValue());doIamRequest("post",getVerifyAnalysisUrl(),captchaParam,function(res){runtime.flags.isVerifying=false;var codeOkValue=_check("definition.codeOkValue",settings.definition.codeOkValue);if(!Common.Util.isEmpty(res)&&(res.code!=codeOkValue)){resetCaptcha();settings.captcha.onError(res.message)}else{runtime.verifiedModel=res.data.verifiedModel;Common.Util.checkEmpty("captcha.getVerifier",settings.captcha.getVerifier)().captchaDestroy(false)}},function(errmsg){runtime.flags.isVerifying=false;resetCaptcha();settings.captcha.onError(errmsg)},true)}}})}})};var _InitAccountAuthenticator=function(){if(!settings.account.enable){console.warn("Account authenticator not enable!");return}$(function(){$(document).bind("keydown",function(event){if(event.keyCode==13){$(Common.Util.checkEmpty("account.submitBtn",settings.account.submitBtn)).click()}});$(Common.Util.checkEmpty("account.submitBtn",settings.account.submitBtn)).click(function(){var principal=encodeURIComponent(Common.Util.getEleValue("account.principal",settings.account.principal));var plainPasswd=Common.Util.getEleValue("account.credential",settings.account.credential);if(Common.Util.isAnyEmpty(principal,plainPasswd)){settings.account.onError(Common.Util.isZhCN()?"请输入账户名和密码":"Please input your account and password");return}_InitSafeCheck(function(checkCaptcha,checkGeneric,checkSms){runtime.clientSecretKey=IAMCrypto.RSA.generateKey();var secretKey=Common.Util.checkEmpty("Secret is empty",checkGeneric.secretKey);var credentials=encodeURIComponent(IAMCrypto.RSA.encryptToHexString(secretKey,plainPasswd));var verifiedToken="";if(runtime.safeCheck.checkCaptcha.enabled){verifiedToken=runtime.verifiedModel.verifiedToken;if(Common.Util.isEmpty(verifiedToken)){settings.account.onError(Common.Util.isZhCN()?"请完成人机验证":"Please complete man-machine verify");return}}if(Common.Util.isAnyEmpty(principal,credentials)){settings.account.onError("No empty login name or password allowed");return}if(!settings.account.onBeforeSubmit(principal,credentials,verifiedToken)){return}$(Common.Util.checkEmpty("account.submitBtn",settings.account.submitBtn)).attr("disabled",true);var loginParam=new Map();loginParam.set("{principalKey}",principal);loginParam.set("{credentialKey}",credentials);loginParam.set("{clientSecretKey}",runtime.clientSecretKey.publicKeyHex);loginParam.set("{clientRefKey}",clientRef());loginParam.set("{verifiedTokenKey}",verifiedToken);loginParam.set("{verifyTypeKey}",Common.Util.checkEmpty("captcha.use",settings.captcha.use));loginParam.set("{secureAlgKey}",runtime.handshake.handleChooseSecureAlg());loginParam.set("{umidTokenKey}",runtime.umid.getValue());doIamRequest("post","{accountSubmitUri}",loginParam,function(resp){$(Common.Util.checkEmpty("account.submitBtn",settings.account.submitBtn)).removeAttr("disabled");runtime.verifiedModel.verifiedToken="";var codeOkValue=Common.Util.checkEmpty("definition.codeOkValue",settings.definition.codeOkValue);if(!Common.Util.isEmpty(resp)&&(resp.code!=codeOkValue)){resetCaptcha();settings.account.onError(resp.message)}else{$(document).unbind("keydown");var redirectUrl=Common.Util.checkEmpty("Login successfully, response data.redirect_url is empty",resp.data[settings.definition.redirectUrlKey]);if(settings.account.onSuccess(principal,redirectUrl)){Common.Util.getRootWindow(window).location.href=redirectUrl}}},function(errmsg){$(Common.Util.checkEmpty("account.submitBtn",settings.account.submitBtn)).removeAttr("disabled");runtime.verifiedModel.verifiedToken="";settings.account.onError(errmsg)},true)})})})};var _InitSMSAuthenticator=function(){if(!settings.sms.enable){console.warn("SMS authenticator not enable!");return}$(function(){$(Common.Util.checkEmpty("sms.sendSmsBtn",settings.sms.sendSmsBtn)).click(function(){var mobileArea=Common.Util.getEleValue("sms.mobileArea",settings.sms.mobileArea,false);var mobileNum=mobileArea+Common.Util.getEleValue("sms.mobile",settings.sms.mobile,false);if(Common.Util.isEmpty(mobileNum)){settings.sms.onError("SMS login for mobile number is required.");return}var imgInput=$(Common.Util.checkEmpty("captcha.input",settings.captcha.input));var captcha=imgInput.val();if(runtime.safeCheck.captchaEnabled){if(Common.Util.isEmpty(captcha)||captcha.length<imgInput.attr("maxlength")){settings.account.onError("Illegal length of captcha input");return}}var getSmsParam=new Map();getSmsParam.set("{principalKey}",encodeURIComponent(mobileNum));getSmsParam.set("{verifiedTokenKey}",captcha);doIamRequest("post","{smsApplyUri}",getSmsParam,function(res){var codeOkValue=Common.Util.checkEmpty("definition.codeOkValue",settings.definition.codeOkValue);if(!Common.Util.isEmpty(resp)&&(resp.code!=codeOkValue)){settings.sms.onError(resp.message)}else{settings.sms.onSuccess(resp);var remainDelaySec=resp.data.checkSms.remainDelayMs/1000;var num=parseInt(remainDelaySec);var timer=setInterval(()=>{var sendSmsBtn=$(settings.sms.sendSmsBtn);if(num<1){sendSmsBtn.attr('disabled',false);sendSmsBtn.text('获取');clearInterval(timer)}else{sendSmsBtn.attr('disabled',true);sendSmsBtn.text(num+'s');num--}},1000)}},function(errmsg){settings.sms.onError(errmsg)},true)});$(Common.Util.checkEmpty("sms.submitBtn",settings.sms.submitBtn)).click(function(){var mobileArea=Common.Util.getEleValue("sms.mobileArea",settings.sms.mobileArea,false);var mobileNum=mobileArea+Common.Util.getEleValue("sms.mobile",settings.sms.mobile,false);var smsCode=Common.Util.getEleValue("sms.smsCode",settings.sms.smsCode,false);if(!settings.sms.onBeforeSubmit(mobileNum,smsCode)){return}var smsLoginParam=new Map();smsLoginParam.set("{principalKey}",encodeURIComponent(mobileNum));smsLoginParam.set("{credentialKey}",smsCode);smsLoginParam.set("{smsActionKey}",Common.Util.checkEmpty("definition.smsActionValueLogin",settings.definition.smsActionValueLogin));doIamRequest("post","{smsSubmitUri}",smsLoginParam,function(res){var codeOkValue=Common.Util.checkEmpty("definition.codeOkValue",settings.definition.codeOkValue);if(!Common.Util.isEmpty(resp)&&(resp.code!=codeOkValue)){settings.sms.onError(resp.message)}else{settings.sms.onSuccess(resp);Common.Util.getRootWindow(window).location.href=resp.data.redirect_url}},function(errmsg){settings.sms.onError(errmsg)},true)});if(runtime.safeCheck.checkSms.enabled){$(settings.sms.mobile).val(runtime.safeCheck.checkSms.mobileNum);var remainDelaySec=runtime.safeCheck.checkSms.remainDelayMs/1000;var num=parseInt(remainDelaySec);var timer=setInterval(()=>{var sendSmsBtn=$(settings.sms.sendSmsBtn);if(num<1){sendSmsBtn.attr('disabled',false);var getBtnText="新获取验证码";if(!Common.Util.isZhCN()){getBtnText="Get verify code"}sendSmsBtn.text(getBtnText);clearInterval(timer)}else{sendSmsBtn.attr('disabled',true);sendSmsBtn.text(num+'s');num--}},1000)}})};var clientRef=function(){var clientRef=null;var osTypes=Common.Util.PlatformType;for(var osname in osTypes){if(osTypes[osname]){console.debug("Got current OS: "+osname);clientRef=osname;break}}if(Common.Util.isEmpty(clientRef)){clientRef="Unknown";console.warn("Unknown platform browser ["+navigator.appVersion+"]")}return clientRef};var doIamRequest=function(method,urlAndKey,paramMap,success,error,sessionIfNecessary){paramMap.set("{responseType}",Common.Util.checkEmpty("definition.responseTypeValue",settings.definition.responseTypeValue));if(sessionIfNecessary){runtime.handshake.handleSessionTo(paramMap)}var _url=Common.Util.checkEmpty("deploy.baseUri",settings.deploy.baseUri);if(urlAndKey.startsWith("{")&&urlAndKey.endsWith("}")){var realKey=urlAndKey.substr(1,urlAndKey.length-2);_url+=Common.Util.checkEmpty("definition",settings.definition[realKey])}else{_url+=Common.Util.checkEmpty("definition",settings.definition[urlAndKey])}$.ajax({url:_url,type:method,data:Common.Util.toUrl(settings.definition,paramMap),xhrFields:{withCredentials:true},success:function(res,textStatus,jqxhr){success(res)},error:function(req,status,errmsg){error(errmsg)}})};window.IAMCore=function(){};IAMCore.prototype.init=function(opt){_initConfigure(opt);runtime.umid.getValuePromise().then(umidToken=>runtime.handshake.getValuePromise(umidToken)).then(handshakeValue=>{_InitAccountAuthenticator();_InitSMSAuthenticator();_InitSNSAuthenticator();_InitCaptchaVerifier()});return this};IAMCore.prototype.getIamBaseUri=function(){return window.sessionStorage.getItem(constant.baseUriStoredKey)};IAMCore.prototype.getUMToken=function(){return runtim.umid.getValue()}})(window,document);