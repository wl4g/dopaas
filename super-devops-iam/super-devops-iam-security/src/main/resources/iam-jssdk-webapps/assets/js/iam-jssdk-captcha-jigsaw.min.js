(function(d){var e={primaryImg:null,applyToken:null,verifyType:null,secret:null,y:0},k={verified:!1,verifiedToken:null},g=function(a,c){this.element0=d(a);this.options=d.extend({},g.DEFAULTS,c);a=(a=this.element0.width())?a:this.options.width;this.element0.css({width:a+"px"});this.initDOM();this.initImg();this.bindEvents()};g.VERSION="latest";g.Author="\x3cWanglsir@gmail.com, 983708408@qq.com, babaa1f4@163.com\x3e";g.DEFAULTS={width:280,height:155,loadingText:Common.Util.isZhCN()?"加载中...":"Loading...",
failedText:Common.Util.isZhCN()?"再试一次":"Let's try again?",barText:Common.Util.isZhCN()?"请拖动滑块完成拼图":"Drag to complete the jigsaw",repeatIcon:"fa fa-repeat",getApplyCaptchaUrl:null,getVerifyAnalysisUrl:null,verifyDataKey:"verifyData",applyCaptcha:function(a,c,b){var h=this,f=Common.Util.checkEmpty("optinos.getApplyCaptchaUrl",h.getApplyCaptchaUrl()),t=f.substring(0,f.lastIndexOf("?"));d.ajax({url:t,type:"post",data:Common.Util.toUrl({},Common.Util.toUrlQueryParam(f)),xhrFields:{withCredentials:!0},
success:function(f){200==f.code?(e=f.data.applyModel,a.setSrc(e.primaryImg),c.setSrc(e.blockImg),c.imagey=e.y):(d(".sliderContainer").find(".slider").unbind(),d(b).text(f.message),Common.Util.checkEmpty("options.onFail",h.onFail)("Failed to jigsaw apply captcha, "+f.message))},error:function(a,c,b){console.debug(b);d(".sliderContainer").find(".slider").unbind();Common.Util.checkEmpty("options.onFail",h.onFail)("Failed to jigsaw apply captcha, "+b)}})},verifyAnalysis:function(a,c){c=new String(c);
var b=Common.Util.Crc16CheckSum.crc16Modbus(e.applyToken);c=CryptoJS.enc.Hex.stringify(CryptoJS.SHA512(c+e.applyToken)).substring(31,97)+c*b;c=IAMCrypto.RSA.encryptToHexString(e.secret,c);var h=null;a={applyToken:e.applyToken,x:c,trails:a};var f=this,b=Common.Util.checkEmpty("options.getVerifyAnalysisUrl",f.getVerifyAnalysisUrl());c=b.substring(0,b.lastIndexOf("?"));b=Common.Util.toUrlQueryParam(b);b.set(Common.Util.checkEmpty("options.verifyDataKey",f.verifyDataKey),Common.Util.Codec.encodeBase58(JSON.stringify(a)));
d.ajax({url:c,xhrFields:{withCredentials:!0},type:"post",async:!1,data:Common.Util.toUrl({},b),success:function(a){200==a.code?(h=k=a.data.verifiedModel,d(".sliderContainer").find(".slider").unbind(),Common.Util.checkEmpty("options.onSuccess",f.onSuccess)(k.verifiedToken)):Common.Util.checkEmpty("options.onFail",f.onFail)("Failed to jigsaw verify captcha, caused by: "+a.message)},error:function(a,c,b){console.debug(b);Common.Util.checkEmpty("options.onFail",f.onFail)("Failed to jigsaw verify captcha, caused by: "+
b)}});return h},onSuccess:function(a){console.debug("Jigsaw captcha verifyed successful. verifiedToken: "+a)},onFail:function(a){console.error(a)}};g.prototype.initDOM=function(){var a=function(a,b){a=document.createElement(a);a.className=b;return a},c=function(a,b){var c=document.createElement("canvas");c.width=a;c.height=b;return c},b=a("div","JigsawIamCaptcha card");b.style.display="none";var h=a("div","card-header");h.style.paddingLeft="20px";h.style.paddingTop="5px";var f=function(a,b){a=document.createElement(a);
a.innerText=b;return a}("span",Common.Util.isZhCN()?"请完成人机验证":"Please complete man-machine verification"),g=a("div","card-body"),e=c(this.options.width,this.options.height),c=c(this.options.width,this.options.height),l=a("div","sliderContainer"),p=a("i","refreshIcon "+this.options.repeatIcon),m=a("div","sliderMask"),q=a("div","sliderbg"),n=a("div","slider"),k=a("i","fa fa-arrow-right sliderIcon"),a=a("span","sliderText");c.className="block";a.innerHTML=this.options.barText;var r=this.element0;r.append(b);
b.append(h);h.append(f);h.append(p);b.append(g);g.append(e);g.append(c);n.appendChild(k);m.appendChild(n);l.appendChild(q);l.appendChild(m);q.appendChild(a);r.append(l);b={canvas:e,block:c,card:b,sliderContainer:d(l),refreshIcon:p,slider:n,sliderMask:m,sliderIcon:k,text:d(a),canvasCtx:e.getContext("2d"),blockCtx:c.getContext("2d")};d.isFunction(Object.assign)?Object.assign(this,b):d.extend(this,b)};g.prototype.initImg=function(){var a=this,c=new Image;c.crossOrigin="Anonymous";var b=new Image;b.crossOrigin=
"Anonymous";c.onload=function(){a.canvasCtx.drawImage(c,0,0)};b.onload=function(){a.blockCtx.drawImage(b,0,b.imagey);console.debug(b.imagey);a.text.text(a.text.attr("data-text"))};c.setSrc=function(b){a.text.removeClass("text-danger");c.src=b.startsWith("data:")?b:"data:image/png;base64,"+b};b.setSrc=function(c){a.text.removeClass("text-danger");b.src=c.startsWith("data:")?c:"data:image/png;base64,"+c};this.text.attr("data-text",this.options.barText);this.text.text(this.options.loadingText);this.img1=
c;this.img2=b;this.applyCaptcha()};g.prototype.bindEvents=function(){var a=this;this.element0.on("selectstart",function(){return!1});d(this.refreshIcon).on("click",function(){a.text.text(a.options.barText);a.reset();d.isFunction(a.options.onRefresh)&&a.options.onRefresh.call(a.element0)});var c,b,g=[],f=!1,e=function(d){a.text.hasClass("text-danger")||(c=d.clientX,b=d.clientY,f=!0)},k=function(d){d.preventDefault();if(!f)return!1;var e=d.clientX;d=d.clientY;var h=1;document.body.style.zoom&&(h=parseFloat(document.body.style.zoom));
e=(e-c)/h;d=(d-b)/h;if(0>e||e+46>a.options.width)return!1;a.slider.style.left=e+"px";a.block.style.left=e+"px";a.sliderContainer.addClass("sliderContainer_active");a.sliderMask.style.width=e+4+"px";g.push({t:(new Date).getTime(),x:e,y:d})},l=function(b){if(!f)return!1;f=!1;if(b.clientX===c)return!1;a.sliderContainer.removeClass("sliderContainer_active");a.trails=g;(b=a.verifyAnalysis())&&b.verified?(a.sliderContainer.addClass("sliderContainer_success"),a.text.text(Common.Util.isZhCN()?"验证通过":"Verified"),
d.isFunction(a.options.onSuccess(b.verifiedToken))&&a.options.onSuccess.call(a.element0)):(a.sliderContainer.addClass("sliderContainer_fail"),setTimeout(function(){a.text.text(a.options.failedText);a.reset()},1E3))};d(this.slider).bind("mousedown",e);d(this.slider).bind("touchstart",e);d(this.slider).bind("mouseenter",function(){d(a.card).fadeIn(200)});d(this.element0).bind("mouseleave",function(){a.sliderContainer.hasClass("sliderContainer_active")||d(a.card).fadeOut(50)});d(document).bind("mousemove",
k);d(document).bind("touchmove",k);d(document).bind("mouseup",l);d(document).bind("touchend",l)};g.prototype.applyCaptcha=function(){this.options.applyCaptcha(this.img1,this.img2,this.text)};g.prototype.verifyAnalysis=function(){var a=parseInt(this.block.style.left);return this.options.verifyAnalysis(this.trails,a)};g.prototype.reset=function(){this.sliderContainer.removeClass("sliderContainer_fail sliderContainer_success");this.slider.style.left=0;this.block.style.left=0;this.sliderMask.style.width=
0;this.canvasCtx.clearRect(0,0,this.options.width,this.options.height);this.blockCtx.clearRect(0,0,this.options.width,this.options.height);this.block.width=this.options.width;this.text.attr("data-text",this.text.text());this.text.text(this.options.loadingText);this.applyCaptcha()};d.fn.JigsawIamCaptcha=function(a){return this.each(function(){var c=d(this),b=c.data("lgb.JigsawIamCaptcha");b&&(d(".sliderContainer").remove(),c.removeData("lgb.JigsawIamCaptcha"));c.data("lgb.JigsawIamCaptcha",b=new g(this,
"object"===typeof a&&a));if("string"===typeof a)b[a]()})}})(jQuery);