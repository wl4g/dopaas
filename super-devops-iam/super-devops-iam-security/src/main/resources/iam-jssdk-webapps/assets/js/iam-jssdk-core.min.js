(function(n,q){var k={baseUriStoredKey:"__IAM_BASEURI",umidTokenStorageKey:"__IAM_UMIDTOKEN",useSecureAlgorithmName:"RSA"},d={that:null,umid:{_value:null,getValue:function(){return Common.Util.checkEmpty("Fatal error, umidToken value is null, No attention to call order (must be executed after runtime.umid.getValuePromise())",d.umid._value)},_currentlyInGettingValuePromise:null,getValuePromise:function(){if(d.umid._currentlyInGettingValuePromise)return d.umid._currentlyInGettingValuePromise;var a=
Common.Util.Codec.decodeBase58(sessionStorage.getItem(k.umidTokenStorageKey));return Common.Util.isEmpty(a)?d.umid._currentlyInGettingValuePromise=new Promise(function(a,e){IamFingerprint.getFingerprint({},function(b){var f=new Map;f.set("userAgent",b.components.get("userAgent"));f.set("platform",b.components.get("platform"));f.set("pixelRatio",b.components.get("pixelRatio"));f.set("timezone",b.components.get("timezone"));f.set("language",b.components.get("language"));f.set("cpuClass",b.components.get("cpuClass"));
f.set("touchSupport",b.components.get("touchSupport"));f.set("deviceMemory",b.components.get("deviceMemory"));f.set("availableScreenResolution",b.components.get("availableScreenResolution"));f.set("canvas",CryptoJS.MD5(b.components.get("canvas")).toString(CryptoJS.enc.Hex));f.set("webgl",CryptoJS.MD5(b.components.get("webgl")).toString(CryptoJS.enc.Hex));f.set("indexedDb",b.components.get("indexedDb"));f.set("sessionStorage",b.components.get("sessionStorage"));f.set("localStorage",b.components.get("localStorage"));
f.set("colorDepth",b.components.get("colorDepth"));b=new Map;for(var h=Common.Util.toUrl({},f),f=100+parseInt(100*Math.random()),l=parseInt(f%3+1),u=0;u<l;u++)h=Common.Util.Codec.encodeBase58(h);h=f+"!"+h;console.debug("Generated apply umidToken data: "+h);b.set("umdata",h);m("post","{applyUmTokenUri}",b,function(b){Common.Util.checkEmpty("init.onPostUmidToken",c.init.onPostUmidToken)(b);var e=Common.Util.checkEmpty("definition.codeOkValue",c.definition.codeOkValue);Common.Util.isEmpty(b)||b.code!=
e||(console.debug("Got umidToken: "+b.data.umidToken),e=Common.Util.Codec.encodeBase58(b.data.umidToken),sessionStorage.setItem(k.umidTokenStorageKey,e),a(b.data.umidToken),d.umid._value=b.data.umidToken);d.umid._currentlyInGettingValuePromise=null},function(b){d.umid._currentlyInGettingValuePromise=null;console.warn("Failed to gets umidToken, "+b);Common.Util.checkEmpty("init.onError",c.init.onError)(b);e(b)},!1)})}):(d.umid._value=a,new Promise(function(c,e){return c(a)}))}},handshake:{_value:null,
getValue:function(){return Common.Util.checkEmpty("Fatal error, handshake value is null, No attention to call order (must be executed after runtime.handshake.getValuePromise())",d.handshake._value)},_currentlyInGettingValuePromise:null,getValuePromise:function(a){return d.handshake._currentlyInGettingValuePromise?d.handshake._currentlyInGettingValuePromise:Common.Util.isEmpty(d.handshake._value)?d.handshake._currentlyInGettingValuePromise=new Promise(function(b,e){e=new Map;e.set("{umidTokenKey}",
Common.Util.checkEmpty("umidToken",a));m("post","{handshakeUri}",e,function(a){var e=Common.Util.checkEmpty("definition.codeOkValue",c.definition.codeOkValue);Common.Util.isEmpty(a)||a.code!=e||(d.handshake._value=$.extend(!0,d.handshake._value,a.data),b(d.handshake._value));d.handshake._currentlyInGettingValuePromise=null},function(b){d.handshake._currentlyInGettingValuePromise=null;console.log("Failed to handshake, "+b);Common.Util.checkEmpty("init.onError",c.init.onError)(b)},!1)}):new Promise(function(b,
a){return b(d.handshake._value)})},handleSessionTo:function(a){Common.Util.isAnyEmpty(d.handshake._value.session.sk,d.handshake._value.session.sv)||(Common.Util.isObject(a)?a[d.handshake._value.session.sk]=d.handshake._value.session.sv:Common.Util.isMap(a)&&a.set(d.handshake._value.session.sk,d.handshake._value.session.sv))},handleChooseSecureAlg:function(){var a=d.handshake.getValue().algs;for(index in a)if(Common.Util.Codec.decodeBase58(a[index]).startsWith(k.useSecureAlgorithmName))return a[index];
throw Error("No such secure algoritm of: "+k.useSecureAlgorithmName);}},safeCheck:{checkGeneric:{secretKey:null},checkCaptcha:{enabled:!1,support:null,applyUri:null},checkSms:{enabled:!1,mobileNum:null,remainDelayMs:null}},clientSecretKey:{},applyModel:{primaryImg:null,applyToken:null,verifyType:null},verifiedModel:{verified:!0,verifiedToken:null},flags:{isCurrentlyApplying:!1,isVerifying:!1}},r={captchaLen:5,captchaDestroy:function(a){var b=Common.Util.checkEmpty("captcha.input",c.captcha.input),
e=Common.Util.checkEmpty("captcha.img",c.captcha.img);$(e).unbind("click");$(e).attr({src:"./static/images/ok.png"});$(b).attr("disabled",!0);$(b).css({cursor:"context-menu"});a&&($(b).val(""),$(b).css({display:"none"}),$(e).attr({src:""}),$(e).css({display:"none"}))},captchaRender:function(){d.flags.isCurrentlyApplying=!1;var a=$(Common.Util.checkEmpty("captcha.input",c.captcha.input)),b=Common.Util.checkEmpty("captcha.img",c.captcha.img);a.val("");$(b).click(function(){p(!0)});m("get",v(),new Map,
function(e){d.flags.isCurrentlyApplying=!1;d.applyModel=e.data.applyModel;$(a).css({display:"none",cursor:"text"});$(a).removeAttr("disabled");$(b).css({display:"none"});var f=Common.Util.checkEmpty("definition.codeOkValue",c.definition.codeOkValue);Common.Util.isEmpty(e)||e.code!=f?($(b).attr("title",e.message),$(b).unbind("click"),setTimeout(function(){$(b).click(function(){p(!0)})},15E3)):$(b).attr("src",e.data.applyModel.primaryImg)},function(b,a,d){console.debug("Failed to apply captcha, "+d);
Common.Util.checkEmpty("captcha.onError",c.captcha.onError)(d)},!0)}},c={definition:{codeOkValue:"200",responseType:"response_type",responseTypeValue:"json",whichKey:"which",redirectUrlKey:"redirect_url",refreshUrlKey:"refresh_url",principalKey:"principal",credentialKey:"credential",clientSecretKey:"clientSecretKey",verifyTypeKey:"verifyType",applyTokenKey:"applyToken",verifyDataKey:"verifyData",verifiedTokenKey:"verifiedToken",clientRefKey:"client_ref",umidTokenKey:"umidToken",secureAlgKey:"alg",
smsActionKey:"action",smsActionValueLogin:"login",applyUmTokenUri:"/rcm/applyumtoken",handshakeUri:"/login/handshake",checkUri:"/login/check",captchaApplyUri:"/verify/applycaptcha",verifyAnalyzeUri:"/verify/verifyanalysis",accountSubmitUri:"/auth/generic",smsApplyUri:"/verify/applysmsverify",smsSubmitUri:"/auth/sms",snsConnectUri:"/sns/connect/",applyXsrfTokenUrlKey:"/xsrf/xtoken",xsrfTokenHeaderKey:"X-Iam-Xsrf-Token",xsrfTokenParamKey:"_xsrf",replayTokenHeaderKey:"X-Iam-Replay-Token",replayTokenParamKey:"_replayToken"},
deploy:{baseUri:null,defaultTwoDomain:"iam",defaultServerPort:14040,defaultContextPath:"/iam-server"},init:{onPostUmidToken:function(a){console.debug("onPostUmidToken... "+a)},onPreCheck:function(a){console.debug("onPreCheck... principal:"+a);return!0},onPostCheck:function(a){console.debug("onPostCheck... "+a)},onError:function(a){console.error("Failed to initialize... "+a)}},captcha:{enable:!1,use:"VerifyWithGifGraph",panel:null,img:null,input:null,getVerifier:function(){var a=Common.Util.checkEmpty("captcha.use",
c.captcha.use),b=Common.Util.checkEmpty("captcha.registry",c.captcha.registry),e;for(e in b)if(e==a)return b[e];throw"Illegal verifier type for '"+e+"'";},registry:{VerifyWithSimpleGraph:r,VerifyWithGifGraph:r,VerifyWithJigsawGraph:{captchaDestroy:function(a){var b=Common.Util.checkEmpty("captcha.panel",c.captcha.panel);a&&$(b).css({display:"none"})},captchaRender:function(){d.flags.isCurrentlyApplying=!1;var a=Common.Util.checkEmpty("captcha.panel",c.captcha.panel);$(a).JigsawIamCaptcha({verifyDataKey:Common.Util.checkEmpty("definition.verifyDataKey",
c.definition.verifyDataKey),getApplyCaptchaUrl:v,getVerifyAnalysisUrl:w,repeatIcon:"fa fa-redo",onSuccess:function(b){console.debug("Jigsaw captcha verify successful. verifiedToken is '"+b+"'");d.flags.isCurrentlyApplying=!1;d.verifiedModel.verifiedToken=b;Common.Util.checkEmpty("captcha.onSuccess",c.captcha.onSuccess)(b)},onFail:function(b){console.debug("Failed to jigsaw captcha verify. element \x3d\x3e "+b);d.flags.isCurrentlyApplying=!1;d.verifiedModel.verifiedToken="";Common.Util.checkEmpty("captcha.onError",
c.captcha.onError)(b)}})}}},onSuccess:function(a){console.debug("Jigsaw captcha verify successfully. verifiedToken is '"+a+"'")},onError:function(a){console.error("Failed to jigsaw captcha verify. "+a)}},account:{enable:!1,submitBtn:null,principalInput:null,credentialInput:null,customParamMap:new Map,onBeforeSubmit:function(a,b,c){console.debug("Prepare to submit login request. principal\x3d"+a+", verifiedToken\x3d"+c);return!0},onSuccess:function(a,b){console.info("Sign in successfully. "+b.principal+
", "+b.redirectUrl);return!0},onError:function(a){console.error("Sign in error. "+a)}},sms:{enable:!1,submitBtn:null,sendSmsBtn:null,mobileArea:null,mobile:null,onBeforeSubmit:function(a,b){console.log("Prepare to submit SMS login request. mobileNum\x3d"+a+", smsCode\x3d"+b);return!0},onSuccess:function(a){console.log("SMS success. "+a.message)},onError:function(a){throw"SMS login error. "+a;}},sns:{enable:!1,required:{getWhich:function(a,b){throw"Unsupported errors, please implement to support get which function";
},refreshUrl:null},getPrincipal:function(){},qrcodePanel:null,pagePanel:null,provider:null,onBefore:function(a,b,c){}}},x=function(){var a=location.protocol,b=location.hostname,e=c.deploy.defaultTwoDomain,f=c.deploy.defaultContextPath,f=f.startsWith("/")?f:"/"+f;if(Common.Util.isIp(b)||"localhost"==b||"127.0.0.1"==b||b.endsWith(".debug")||b.endsWith(".local")||b.endsWith(".dev"))return a+"//"+b+":"+port;var d=b.split(".").slice(-2).join(".");0<b.indexOf("com.cn")&&(d=b.split(".").slice(-3).join("."));
return a+"//"+e+"."+d+f},v=function(){var a=new Map,b=encodeURIComponent(Common.Util.getEleValue("account.principalInput",c.account.principalInput));a.set(Common.Util.checkEmpty("definition.principalKey",c.definition.principalKey),b);a.set(Common.Util.checkEmpty("definition.umidTokenKey",c.definition.umidTokenKey),d.umid.getValue());a.set(Common.Util.checkEmpty("definition.verifyTypeKey",c.definition.verifyTypeKey),Common.Util.checkEmpty("captcha.use",c.captcha.use));a.set(Common.Util.checkEmpty("definition.responseType",
c.definition.responseType),Common.Util.checkEmpty("definition.responseTypeValue",c.definition.responseTypeValue));a.set(Common.Util.checkEmpty("definition.secureAlgKey",c.definition.secureAlgKey),d.handshake.handleChooseSecureAlg());b=d.that.getXsrfToken();a.set(b.paramName,b.value);b=d.that.generateReplayToken();a.set(b.paramName,b.value);d.handshake.handleSessionTo(a);a.set("r",Math.random());return Common.Util.checkEmpty("checkCaptcha.applyUri",d.safeCheck.checkCaptcha.applyUri)+"?"+Common.Util.toUrl({},
a)},w=function(){var a=new Map,b=encodeURIComponent(Common.Util.getEleValue("account.principalInput",c.account.principalInput));a.set(Common.Util.checkEmpty("definition.principalKey",c.definition.principalKey),b);a.set(Common.Util.checkEmpty("definition.umidTokenKey",c.definition.umidTokenKey),d.umid.getValue());a.set(Common.Util.checkEmpty("definition.verifyTypeKey",c.definition.verifyTypeKey),Common.Util.checkEmpty("captcha.use",c.captcha.use));a.set(Common.Util.checkEmpty("definition.responseType",
c.definition.responseType),Common.Util.checkEmpty("definition.responseTypeValue",c.definition.responseTypeValue));a.set(Common.Util.checkEmpty("definition.secureAlgKey",c.definition.secureAlgKey),d.handshake.handleChooseSecureAlg());a.set("r",Math.random());b=d.that.getXsrfToken();a.set(b.paramName,b.value);b=d.that.generateReplayToken();a.set(b.paramName,b.value);d.handshake.handleSessionTo(a);return Common.Util.checkEmpty("deploy.baseUri",c.deploy.baseUri)+Common.Util.checkEmpty("definition.verifyAnalyzeUri",
c.definition.verifyAnalyzeUri)+"?"+Common.Util.toUrl({},a)},p=function(a){a?(a=encodeURIComponent(Common.Util.getEleValue("account.principalInput",c.account.principalInput,!1)),t(a,function(b,a,f){b.enabled&&!d.flags.isCurrentlyApplying&&Common.Util.checkEmpty("captcha.getVerifier",c.captcha.getVerifier)().captchaRender()})):Common.Util.checkEmpty("captcha.getVerifier",c.captcha.getVerifier)().captchaRender()},z=function(a,b){if("qrcodePanel"==b){var e=q.querySelector("#iam_qrcode_panel_iframe");
if(null==e||0>=e.length){e=Common.Util.checkEmpty("sns.qrcodePanel",c.sns.qrcodePanel);b=Common.Util.checkEmpty("qrcodePanel.src",e.src);var f=e.width||"250",d=e.height||"260",e=q.createElement("iframe");e.setAttribute("id","iam_qrcode_panel_iframe");e.setAttribute("frameborder","1");e.setAttribute("scrolling","no");e.setAttribute("width",f);e.setAttribute("height",d);e.setAttribute("style","border:solid 0;");b.appendChild(e)}setTimeout(function(){var b=q.querySelector("#iam_qrcode_panel_iframe");
-1==navigator.userAgent.indexOf("MSIE")?b.src=a:b.location=a},2)}else if("pagePanel"==b){b=Common.Util.checkEmpty("sns.pagePanel",c.sns.pagePanel);var h=n.open(a,n,"modal\x3d"+(b.modal||"yes")+",width\x3d"+(b.width||"800px")+",height\x3d"+(b.height||"500px")+",resizable\x3d"+(b.resizable||"no")+",left\x3d"+(b.left||"250px")+",top\x3d"+(b.top||"100px")),l=setInterval(function(){var b=n.document.getElementsByTagName("body")[0].getAttribute("refreshUrl");null!=h&&h.closed&&(clearInterval(l),Common.Util.isEmpty(b)||
(Common.Util.getRootWindow(n).location.href=b))},200)}else throw"Unsupported panelType, use 'qrcodePanel' or 'pagePanel'";},A=function(){if(c.sns.enable){var a=Common.Util.checkEmpty("sns.provider",c.sns.provider),b;for(b in a){var e=a[b],d=Common.Util.checkEmpty(b+".src",e.src),e=Common.Util.checkEmpty(b+".panelType",e.panelType);d.setAttribute("provider",b);d.setAttribute("panelType",e);d.onclick=function(b){var a=b.srcElement;b=a.getAttribute("provider");var a=a.getAttribute("panelType"),e;e=Common.Util.checkEmpty("sns.required",
c.sns.required);var d=Common.Util.checkEmpty("required.getWhich",e.getWhich(b,a));e=c.deploy.baseUri+Common.Util.checkEmpty("definition.snsConnectUri",c.definition.snsConnectUri)+Common.Util.checkEmpty("provider",b)+"?"+Common.Util.checkEmpty("definition.whichKey",c.definition.whichKey)+"\x3d"+d;if("bind"==d.toLowerCase()||"unbind"==d.toLowerCase()){var d=encodeURIComponent(Common.Util.checkEmpty("sns.principal",c.sns.getPrincipal())),f=encodeURIComponent(Common.Util.checkEmpty("sns.required.refreshUrl",
c.sns.required.refreshUrl));e+="\x26"+Common.Util.checkEmpty("definition.principalKey",c.definition.principalKey)+"\x3d"+d;e+="\x26"+Common.Util.checkEmpty("definition.refreshUrlKey",c.definition.refreshUrlKey)+"\x3d"+f}"pagePanel"==a?e+="\x26agent\x3dy":"qrcodePanel"==a&&(e+="\x26agent\x3dn");if(!c.sns.onBefore(b,a,e))return console.warn("onBefore has blocked execution"),this;z(e,a)}}}else console.debug("SNS authenticator not enable!")},t=function(a,b){$(function(){if(Common.Util.checkEmpty("init.onPreCheck",
c.init.onPreCheck)(a)){var e=new Map;e.set("{principalKey}",a);e.set("{verifyTypeKey}",Common.Util.checkEmpty("captcha.use",c.captcha.use));e.set("{umidTokenKey}",d.umid.getValue());e.set("{secureAlgKey}",d.handshake.handleChooseSecureAlg());m("post","{checkUri}",e,function(a){Common.Util.checkEmpty("init.onPostCheck",c.init.onPostCheck)(a);var e=Common.Util.checkEmpty("definition.codeOkValue",c.definition.codeOkValue);Common.Util.isEmpty(a)||a.code!=e||(d.safeCheck=$.extend(!0,d.safeCheck,a.data),
b(a.data.checkCaptcha,a.data.checkGeneric,a.data.checkSms))},function(a){console.log("Failed to safe check, "+a);Common.Util.checkEmpty("init.onError",c.init.onError)(a)},!0)}else console.warn("Skip the init safeCheck, because onPreCheck() return false")})},B=function(){c.captcha.enable?$(function(){p(!0);if("VerifyWithSimpleGraph"==c.captcha.use||"VerifyWithGifGraph"==c.captcha.use){var a=$(Common.Util.checkEmpty("captcha.input",c.captcha.input));a.attr("maxlength",Common.Util.checkEmpty("captcha.getVerifier",
c.captcha.getVerifier)().captchaLen);a.keyup(function(){if(d.safeCheck.checkCaptcha.enabled){var b=a.val();if(!Common.Util.isEmpty(b)&&b.length>=parseInt(a.attr("maxlength"))&&!d.flags.isVerifying){d.flags.isVerifying=!0;var e=new Map;e.put("{verifyDataKey}",b);e.put("{applyTokenKey}",Common.Util.checkEmpty("applyModel.applyToken",d.applyModel.applyToken));e.put("{verifyTypeKey}",Common.Util.checkEmpty("applyModel.verifyType",d.applyModel.verifyType));e.set("{umidTokenKey}",d.umid.getValue());m("post",
w(),e,function(a){d.flags.isVerifying=!1;var b=Common.Util.checkEmpty("definition.codeOkValue",c.definition.codeOkValue);Common.Util.isEmpty(a)||a.code==b?(d.verifiedModel=a.data.verifiedModel,Common.Util.checkEmpty("captcha.getVerifier",c.captcha.getVerifier)().captchaDestroy(!1)):(p(!0),c.captcha.onError(a.message))},function(a){d.flags.isVerifying=!1;p(!0);c.captcha.onError(a)},!0)}}})}}):console.debug("Captcha verifier not enable!")},D=function(){c.account.enable?$(function(){$(q).bind("keydown",
function(a){13==a.keyCode&&$(Common.Util.checkEmpty("account.submitBtn",c.account.submitBtn)).click()});$(Common.Util.checkEmpty("account.submitBtn",c.account.submitBtn)).click(function(){var a=encodeURIComponent(Common.Util.getEleValue("account.principalInput",c.account.principalInput)),b=Common.Util.getEleValue("account.credentialInput",c.account.credentialInput);if(Common.Util.isAnyEmpty(a,b))c.account.onError(Common.Util.isZhCN()?"请输入账户名和密码":"Please input your account and password");else t(a,
function(e,f,g){d.clientSecretKey=IAMCrypto.RSA.generateKey();e=Common.Util.checkEmpty("Secret is empty",f.secretKey);e=encodeURIComponent(IAMCrypto.RSA.encryptToHexString(e,b));f="";if(d.safeCheck.checkCaptcha.enabled&&(f=d.verifiedModel.verifiedToken,Common.Util.isEmpty(f))){c.account.onError(Common.Util.isZhCN()?"请完成人机验证":"Please complete man-machine verify");p(!1);return}if(Common.Util.isAnyEmpty(a,e))c.account.onError("No empty login name or password allowed");else c.account.onBeforeSubmit(a,
e,f)&&($(Common.Util.checkEmpty("account.submitBtn",c.account.submitBtn)).attr("disabled",!0),g=new Map,g.set("{principalKey}",a),g.set("{credentialKey}",e),g.set("{clientSecretKey}",d.clientSecretKey.publicKeyHex),g.set("{clientRefKey}",C()),g.set("{verifiedTokenKey}",f),g.set("{verifyTypeKey}",Common.Util.checkEmpty("captcha.use",c.captcha.use)),g.set("{secureAlgKey}",d.handshake.handleChooseSecureAlg()),g.set("{umidTokenKey}",d.umid.getValue()),Common.Util.mergeMap(c.account.customParamMap,g),
m("post","{accountSubmitUri}",g,function(b){$(Common.Util.checkEmpty("account.submitBtn",c.account.submitBtn)).removeAttr("disabled");d.verifiedModel.verifiedToken="";var e=Common.Util.checkEmpty("definition.codeOkValue",c.definition.codeOkValue);Common.Util.isEmpty(b)||b.code==e?($(q).unbind("keydown"),e=Common.Util.checkEmpty("Login successfully, response data.redirect_url is empty",b.data[c.definition.redirectUrlKey]),c.account.onSuccess(a,b.data)&&(Common.Util.getRootWindow(n).location.href=e)):
(p(!0),c.account.onError(b.message))},function(a){$(Common.Util.checkEmpty("account.submitBtn",c.account.submitBtn)).removeAttr("disabled");d.verifiedModel.verifiedToken="";c.account.onError(a)},!0))})})}):console.debug("Account authenticator not enable!")},E=function(){c.sms.enable?$(function(){$(Common.Util.checkEmpty("sms.sendSmsBtn",c.sms.sendSmsBtn)).click(function(){var a=Common.Util.getEleValue("sms.mobileArea",c.sms.mobileArea,!1)+Common.Util.getEleValue("sms.mobile",c.sms.mobile,!1);if(Common.Util.isEmpty(a))c.sms.onError("SMS login for mobile number is required.");
else{var b=$(Common.Util.checkEmpty("captcha.input",c.captcha.input)),g=b.val();if(d.safeCheck.captchaEnabled&&(Common.Util.isEmpty(g)||g.length<b.attr("maxlength")))c.account.onError("Illegal length of captcha input");else b=new Map,b.set("{principalKey}",encodeURIComponent(a)),b.set("{verifiedTokenKey}",g),m("post","{smsApplyUri}",b,function(a){var b=Common.Util.checkEmpty("definition.codeOkValue",c.definition.codeOkValue);if(Common.Util.isEmpty(a)||a.code==b){c.sms.onSuccess(a);var e=parseInt(a.data.checkSms.remainDelayMs/
1E3),d=setInterval(function(){var a=$(c.sms.sendSmsBtn);1>e?(a.attr("disabled",!1),a.text("获取"),clearInterval(d)):(a.attr("disabled",!0),a.text(e+"s"),e--)},1E3)}else c.sms.onError(a.message)},function(a){c.sms.onError(a)},!0)}});$(Common.Util.checkEmpty("sms.submitBtn",c.sms.submitBtn)).click(function(){var a=Common.Util.getEleValue("sms.mobileArea",c.sms.mobileArea,!1)+Common.Util.getEleValue("sms.mobile",c.sms.mobile,!1),b=Common.Util.getEleValue("sms.smsCode",c.sms.smsCode,!1);if(c.sms.onBeforeSubmit(a,
b)){var d=new Map;d.set("{principalKey}",encodeURIComponent(a));d.set("{credentialKey}",b);d.set("{smsActionKey}",Common.Util.checkEmpty("definition.smsActionValueLogin",c.definition.smsActionValueLogin));m("post","{smsSubmitUri}",d,function(a){var b=Common.Util.checkEmpty("definition.codeOkValue",c.definition.codeOkValue);if(Common.Util.isEmpty(a)||a.code==b)c.sms.onSuccess(a),Common.Util.getRootWindow(n).location.href=a.data.redirect_url;else c.sms.onError(a.message)},function(a){c.sms.onError(a)},
!0)}});if(d.safeCheck.checkSms.enabled){$(c.sms.mobile).val(d.safeCheck.checkSms.mobileNum);var a=parseInt(d.safeCheck.checkSms.remainDelayMs/1E3),b=setInterval(function(){var e=$(c.sms.sendSmsBtn);if(1>a){e.attr("disabled",!1);var d="新获取验证码";Common.Util.isZhCN()||(d="Get verify code");e.text(d);clearInterval(b)}else e.attr("disabled",!0),e.text(a+"s"),a--},1E3)}}):console.debug("SMS authenticator not enable!")},C=function(){var a=null,b=Common.Util.PlatformType,c;for(c in b)if(b[c]){console.debug("Got current OS: "+
c);a=c;break}Common.Util.isEmpty(a)&&(a="Unknown",console.warn("Unknown platform browser ["+navigator.appVersion+"]"));return a},m=function(a,b,e,f,g,h){e.set("{responseType}",Common.Util.checkEmpty("definition.responseTypeValue",c.definition.responseTypeValue));h&&d.handshake.handleSessionTo(e);h=Common.Util.checkEmpty("deploy.baseUri",c.deploy.baseUri);b.startsWith("{")&&b.endsWith("}")&&(b=b.substr(1,b.length-2));h+=Common.Util.checkEmpty("definition",c.definition[b]);b=new Map;if("POST"==a.toUpperCase()||
"DELETE"==a.toUpperCase()){var l=d.that.getXsrfToken();b.set(l.headerName,l.value);l=d.that.generateReplayToken();b.set(l.headerName,l.value)}$.ajax({url:h,type:a,headers:JSON.fromMap(b),data:Common.Util.toUrl(c.definition,e),xhrFields:{withCredentials:!0},success:function(a,b,c){f(a)},error:function(a,b,c){g(c)}})},y=function(){return d.umid.getValuePromise().then(function(a){return d.handshake.getValuePromise(a)})};n.IAMCore=function(a){d.that=this;c=$.extend(!0,c,a);console.debug("After merge settings: "+
JSON.stringify(c));Common.Util.isEmpty(c.deploy.baseUri)&&(c.deploy.baseUri=x(),console.debug("Using overlay iamBaseURI: "+c.deploy.baseUri));sessionStorage.setItem(k.baseUriStoredKey,c.deploy.baseUri)};IAMCore.prototype.getUMToken=function(){return runtim.umid.getValue()};IAMCore.prototype.safeCheck=function(a,b){y().then(function(c){t(a,b)});return this};IAMCore.prototype.anyAuthenticators=function(){return this.accountAuthenticator().smsAuthenticator().snsAuthenticator().captchaVerifier()};IAMCore.prototype.accountAuthenticator=
function(){c.account.enable=!0;return this};IAMCore.prototype.smsAuthenticator=function(){c.sms.enable=!0;return this};IAMCore.prototype.snsAuthenticator=function(){c.sns.enable=!0;return this};IAMCore.prototype.captchaVerifier=function(){c.captcha.enable=!0;return this};IAMCore.prototype.build=function(){y().then(function(a){D();E();A();B()})};IAMCore.prototype.destroy=function(){sessionStorage.removeItem(k.baseUriStoredKey);sessionStorage.removeItem(k.umidTokenStorageKey);c=d=r=k=null;console.log("Destroyed IAMCore instance.")};
IAMCore.prototype.getXsrfToken=function(a){var b=Common.Util.checkEmpty("definition.xsrfTokenHeaderKey",c.definition.xsrfTokenHeaderKey),e=Common.Util.checkEmpty("definition.xsrfTokenParamKey",c.definition.xsrfTokenParamKey),d="IAM-"+location.hostname.split(".").slice(0,1).join(".").toUpperCase()+"-XSRF-TOKEN",d=a?a:d,g=Common.Util.getCookie(d,null);g||(a=IAMCore.getIamBaseUri()+Common.Util.checkEmpty("definition.applyXsrfTokenUrlKey",c.definition.applyXsrfTokenUrlKey),$.ajax({url:a,type:"GET",async:!1,
xhrFields:{withCredentials:!0},success:function(a,b,c){g=Common.Util.getCookie(d)},error:function(a,b,c){console.debug("Failed to init xsrf token. "+c)}}));return{headerName:b,paramName:e,value:g}};IAMCore.prototype.generateReplayToken=function(){for(var a=(new Date).getTime(),b="",e=0;2>e;e++)b+=Math.random().toString(36).substr(2);for(var e=Common.Util.sortWithAscii(b+a),d=Common.Util.Crc16CheckSum.crc16Modbus(e),d=parseInt(d%e.length/Math.PI)+1,g=e,e=0;e<d;e++)g=CryptoJS.MD5(g).toString(CryptoJS.enc.Hex);
e=JSON.stringify({n:b,t:a,s:g});a=Common.Util.checkEmpty("definition.replayTokenHeaderKey",c.definition.replayTokenHeaderKey);b=Common.Util.checkEmpty("definition.replayTokenParamKey",c.definition.replayTokenParamKey);d=Common.Util.Codec.encodeBase58(e);console.debug("Generated replay token(plain): "+e+" - "+d);return{headerName:a,paramName:b,value:d}};IAMCore.getIamBaseUri=function(){var a=sessionStorage.getItem(k.baseUriStoredKey);a||sessionStorage.setItem(k.baseUriStoredKey,a=x());return a}})(window,
document);