(function(p,r){var h={iamVerboseStoredKey:"__IAM_VERBOSE",baseUriStoredKey:"__IAM_BASEURI",umidTokenStorageKey:"__IAM_UMIDTOKEN",authenticatedRedirectCountStorageKey:"__IAM_AUTHC_REDIRECT_COUNT",useSecureAlgorithmName:"RSA"},e={__that:null,umid:{_value:null,getValue:function(){return Common.Util.checkEmpty("Fatal error, umidToken value is null, No attention to call order (must be executed after runtime.umid.getValuePromise())",e.umid._value)},_currentlyInGettingValuePromise:null,getValuePromise:function(){if(e.umid._currentlyInGettingValuePromise)return e.umid._currentlyInGettingValuePromise;
var a=Common.Util.Codec.decodeBase58(sessionStorage.getItem(h.umidTokenStorageKey));return Common.Util.isEmpty(a)?e.umid._currentlyInGettingValuePromise=new Promise(function(a,d){IamFingerprint.getFingerprint({},function(c){var f=new Map;f.set("userAgent",c.components.get("userAgent"));f.set("platform",c.components.get("platform"));f.set("pixelRatio",c.components.get("pixelRatio"));f.set("timezone",c.components.get("timezone"));f.set("language",c.components.get("language"));f.set("cpuClass",c.components.get("cpuClass"));
f.set("touchSupport",c.components.get("touchSupport"));f.set("deviceMemory",c.components.get("deviceMemory"));f.set("availableScreenResolution",c.components.get("availableScreenResolution"));f.set("canvas",CryptoJS.MD5(c.components.get("canvas")).toString(CryptoJS.enc.Hex));f.set("webgl",CryptoJS.MD5(c.components.get("webgl")).toString(CryptoJS.enc.Hex));f.set("indexedDb",c.components.get("indexedDb"));f.set("sessionStorage",c.components.get("sessionStorage"));f.set("localStorage",c.components.get("localStorage"));
f.set("colorDepth",c.components.get("colorDepth"));c=new Map;for(var k=Common.Util.toUrl({},f),f=100+parseInt(100*Math.random()),l=parseInt(f%3+1),m=0;m<l;m++)k=Common.Util.Codec.encodeBase58(k);k=f+"!"+k;console.debug("Generated apply umidToken data: "+k);c.set("umdata",k);n("post",!0,"{applyUmTokenUri}",c,function(c){Common.Util.checkEmpty("init.onPostUmidToken",b.init.onPostUmidToken)(c);var d=Common.Util.checkEmpty("definition.codeOkValue",b.definition.codeOkValue);Common.Util.isEmpty(c)||c.code!=
d||(console.debug("Got umidToken: "+c.data.umidToken),d=Common.Util.Codec.encodeBase58(c.data.umidToken),sessionStorage.setItem(h.umidTokenStorageKey,d),a(c.data.umidToken),e.umid._value=c.data.umidToken);e.umid._currentlyInGettingValuePromise=null},function(a){e.umid._currentlyInGettingValuePromise=null;console.warn("Failed to gets umidToken, "+a);Common.Util.checkEmpty("init.onError",b.init.onError)(a);d(a)},null,!1)})}):(e.umid._value=a,new Promise(function(b,d){return b(a)}))}},handshake:{_value:null,
getValue:function(){return Common.Util.checkEmpty("Fatal error, handshake value is null, No attention to call order (must be executed after runtime.handshake.getValuePromise())",e.handshake._value)},_currentlyInGettingValuePromise:null,getValuePromise:function(a){return e.handshake._currentlyInGettingValuePromise?e.handshake._currentlyInGettingValuePromise:Common.Util.isEmpty(e.handshake._value)?e.handshake._currentlyInGettingValuePromise=new Promise(function(c,d){d=new Map;d.set("{umidTokenKey}",
Common.Util.checkEmpty("umidToken",a));n("post",!0,"{handshakeUri}",d,function(a){Common.Util.checkEmpty("init.onPostHandshake",b.init.onPostHandshake)(a);var d=Common.Util.checkEmpty("definition.codeOkValue",b.definition.codeOkValue);Common.Util.isEmpty(a)||a.code!=d||(e.handshake._value=$.extend(!0,e.handshake._value,a.data),c(a));e.handshake._currentlyInGettingValuePromise=null},function(a){e.handshake._currentlyInGettingValuePromise=null;console.log("Failed to handshake, "+a);Common.Util.checkEmpty("init.onError",
b.init.onError)(a)},null,!1)}):new Promise(function(a,b){return a(e.handshake._value)})},handleSessionTo:function(a){Common.Util.isAnyEmpty(e.handshake._value.session.sk,e.handshake._value.session.sv)||(Common.Util.isObject(a)?a[e.handshake._value.session.sk]=e.handshake._value.session.sv:Common.Util.isMap(a)&&a.set(e.handshake._value.session.sk,e.handshake._value.session.sv))},handleChooseSecureAlg:function(){var a=e.handshake.getValue().algs,c;for(c in a)if(Common.Util.Codec.decodeBase58(a[c]).startsWith(h.useSecureAlgorithmName))return a[c];
throw Error("No such secure algoritm of: "+h.useSecureAlgorithmName);}},safeCheck:{checkGeneric:{secretKey:null},checkCaptcha:{enabled:!1,support:null,applyUri:null},checkSms:{enabled:!1,mobileNum:null,remainDelayMs:null}},clientSecretKey:{},applyModel:{primaryImg:null,applyToken:null,verifyType:null},verifiedModel:{verified:!0,verifiedToken:null},flags:{isCurrentlyApplying:!1,isVerifying:!1}},w={captchaLen:5,captchaDestroy:function(a){var c=Common.Util.checkEmpty("captcha.input",b.captcha.input),
d=Common.Util.checkEmpty("captcha.img",b.captcha.img);$(d).unbind("click");$(d).attr({src:"./static/images/ok.png"});$(c).attr("disabled",!0);$(c).css({cursor:"context-menu"});a&&($(c).val(""),$(c).css({display:"none"}),$(d).attr({src:""}),$(d).css({display:"none"}))},captchaRender:function(){e.flags.isCurrentlyApplying=!1;var a=$(Common.Util.checkEmpty("captcha.input",b.captcha.input)),c=Common.Util.checkEmpty("captcha.img",b.captcha.img);a.val("");$(c).click(function(){q(!0)});n("get",!0,A(),new Map,
function(d){e.flags.isCurrentlyApplying=!1;e.applyModel=d.data.applyModel;$(a).css({display:"none",cursor:"text"});$(a).removeAttr("disabled");$(c).css({display:"none"});var f=Common.Util.checkEmpty("definition.codeOkValue",b.definition.codeOkValue);Common.Util.isEmpty(d)||d.code!=f?($(c).attr("title",d.message),$(c).unbind("click"),setTimeout(function(){$(c).click(function(){q(!0)})},15E3)):$(c).attr("src",d.data.applyModel.primaryImg)},function(a,c,e){console.debug("Failed to apply captcha, "+e);
Common.Util.checkEmpty("captcha.onError",b.captcha.onError)(e)},null,!0)}},b={definition:{codeOkValue:"200",code401Value:"401",statusUnauthenticatedValue:"Unauthenticated",responseType:"response_type",responseTypeValue:"json",whichKey:"which",redirectUrlKey:"redirect_url",refreshUrlKey:"refresh_url",principalKey:"principal",credentialKey:"credential",clientSecretKey:"clientSecretKey",verifyTypeKey:"verifyType",applyTokenKey:"applyToken",verifyDataKey:"verifyData",verifiedTokenKey:"verifiedToken",
clientRefKey:"client_ref",umidTokenKey:"umidToken",secureAlgKey:"alg",smsActionKey:"action",smsActionValueLogin:"login",applyUmTokenUri:"/rcm/applyumtoken",handshakeUri:"/login/handshake",checkUri:"/login/check",captchaApplyUri:"/verify/applycaptcha",verifyAnalyzeUri:"/verify/verifyanalysis",accountSubmitUri:"/auth/generic",smsApplyUri:"/verify/applysmsverify",smsSubmitUri:"/auth/sms",snsConnectUri:"/sns/connect/",applyXsrfTokenUrlKey:"/xsrf/xtoken",xsrfTokenHeaderKey:"X-Iam-Xsrf-Token",xsrfTokenParamKey:"_xsrf",
replayTokenHeaderKey:"X-Iam-Replay-Token",replayTokenParamKey:"_replayToken"},deploy:{baseUri:null,defaultTwoDomain:"iam",defaultServerPort:14040,defaultContextPath:"/iam-server"},init:{onPostUmidToken:function(a){console.debug("onPostUmidToken... "+a)},onPostHandshake:function(a){console.debug("onPostHandshake... "+a)},onPreCheck:function(a){console.debug("onPreCheck... principal:"+a);return!0},onPostCheck:function(a){console.debug("onPostCheck... "+a)},onError:function(a){console.error("Failed to initialize... "+
a)}},captcha:{enable:!1,use:"VerifyWithGifGraph",panel:null,img:null,input:null,getVerifier:function(){var a=Common.Util.checkEmpty("captcha.use",b.captcha.use),c=Common.Util.checkEmpty("captcha.registry",b.captcha.registry),d;for(d in c)if(d==a)return c[d];throw"Illegal verifier type for '"+d+"'";},registry:{VerifyWithSimpleGraph:w,VerifyWithGifGraph:w,VerifyWithJigsawGraph:{captchaDestroy:function(a){var c=Common.Util.checkEmpty("captcha.panel",b.captcha.panel);a&&$(c).css({display:"none"})},captchaRender:function(){e.flags.isCurrentlyApplying=
!1;var a=Common.Util.checkEmpty("captcha.panel",b.captcha.panel);$(a).JigsawIamCaptcha({verifyDataKey:Common.Util.checkEmpty("definition.verifyDataKey",b.definition.verifyDataKey),_getApplyCaptchaUrl:A,_getVerifyAnalysisUrl:B,repeatIcon:"fa fa-redo",onSuccess:function(a){console.debug("Jigsaw captcha verify successful. verifiedToken is '"+a+"'");e.flags.isCurrentlyApplying=!1;e.verifiedModel.verifiedToken=a;Common.Util.checkEmpty("captcha.onSuccess",b.captcha.onSuccess)(a)},onFail:function(a){console.debug("Failed to jigsaw captcha verify. element \x3d\x3e "+
a);e.flags.isCurrentlyApplying=!1;e.verifiedModel.verifiedToken="";Common.Util.checkEmpty("captcha.onError",b.captcha.onError)(a)}})}}},onSuccess:function(a){console.debug("Jigsaw captcha verify successfully. verifiedToken is '"+a+"'")},onError:function(a){console.error("Failed to jigsaw captcha verify. "+a)}},account:{enable:!1,submitBtn:null,principalInput:null,credentialInput:null,customParamMap:new Map,onBeforeSubmit:function(a,c,b){console.debug("Prepare to submit login request. principal\x3d"+
a+", verifiedToken\x3d"+b);return!0},onSuccess:function(a,b){console.info("Sign in successfully. "+b.principal+", "+b.redirectUrl);return!0},onError:function(a){console.error("Sign in error. "+a)}},sms:{enable:!1,submitBtn:null,sendSmsBtn:null,mobileArea:null,mobile:null,onBeforeSubmit:function(a,b){console.log("Prepare to submit SMS login request. mobileNum\x3d"+a+", smsCode\x3d"+b);return!0},onSuccess:function(a){console.log("SMS success. "+a.message)},onError:function(a){throw"SMS login error. "+
a;}},sns:{enable:!1,required:{getWhich:function(a,b){throw"Unsupported errors, please implement to support get which function";},refreshUrl:null},getPrincipal:function(){},qrcodePanel:null,pagePanel:null,provider:null,onBefore:function(a,b,d){}}},t=function(a){if(a){var c=a.status&&a.status==b.definition.statusUnauthenticatedValue;return a.code&&(a.code==b.definition.code401Value||a.code+""==b.definition.code401Value)||c}return!1},u=function(a){var c=Common.Util.checkEmpty("definition.xsrfTokenHeaderKey",
b.definition.xsrfTokenHeaderKey),d=Common.Util.checkEmpty("definition.xsrfTokenParamKey",b.definition.xsrfTokenParamKey),f=location.hostname,e=Common.Util.extTopDomainString(f),k=f,e=f.indexOf(e);0<e&&(k=f.substring(0,e-1));var k=k.replace(".","_").toUpperCase(),l="IAM-"+k+"-XSRF-TOKEN",l=a?a:l,m=Common.Util.getCookie(l,null);IAMCore.Console.debug("Load xsrfToken: "+m+" by cookieName: "+l);m||(a=IAMCore.getIamBaseUri()+Common.Util.checkEmpty("definition.applyXsrfTokenUrlKey",b.definition.applyXsrfTokenUrlKey),
$.ajax({url:a,type:"HEAD",async:!1,xhrFields:{withCredentials:!0},success:function(a,b,c){m=Common.Util.getCookie(l)},error:function(a,b,c){console.debug("Failed to init xsrf token. "+c)}}));return{headerName:c,paramName:d,value:m}},v=function(){for(var a=(new Date).getTime(),c="",d=0;2>d;d++)c+=Math.random().toString(36).substr(2);for(var d=Common.Util.sortWithAscii(c+a),f=Common.Util.Crc16CheckSum.crc16Modbus(d),f=parseInt(f%d.length/Math.PI)+1,e=d,d=0;d<f;d++)e=CryptoJS.MD5(e).toString(CryptoJS.enc.Hex);
d=JSON.stringify({n:c,t:a,s:e});a=Common.Util.checkEmpty("definition.replayTokenHeaderKey",b.definition.replayTokenHeaderKey);c=Common.Util.checkEmpty("definition.replayTokenParamKey",b.definition.replayTokenParamKey);f=Common.Util.Codec.encodeBase58(d);IAMCore.Console.debug("Generated replay token(plain): "+d+" - "+f);return{headerName:a,paramName:c,value:f}},C=function(){var a=location.protocol,c=location.hostname,d=b.deploy.defaultServerPort,f=b.deploy.defaultTwoDomain,e=b.deploy.defaultContextPath,
e=e.startsWith("/")?e:"/"+e;if(Common.Util.isIp(c)||"localhost"==c||"127.0.0.1"==c||c.endsWith(".debug")||c.endsWith(".local")||c.endsWith(".dev"))return a+"//"+c+":"+d+e;c=Common.Util.extTopDomainString(c);return a+"//"+f+"."+c+e},A=function(){var a=new Map,c=encodeURIComponent(Common.Util.getEleValue("account.principalInput",b.account.principalInput));a.set(Common.Util.checkEmpty("definition.principalKey",b.definition.principalKey),c);a.set(Common.Util.checkEmpty("definition.umidTokenKey",b.definition.umidTokenKey),
e.umid.getValue());a.set(Common.Util.checkEmpty("definition.verifyTypeKey",b.definition.verifyTypeKey),Common.Util.checkEmpty("captcha.use",b.captcha.use));a.set(Common.Util.checkEmpty("definition.responseType",b.definition.responseType),Common.Util.checkEmpty("definition.responseTypeValue",b.definition.responseTypeValue));a.set(Common.Util.checkEmpty("definition.secureAlgKey",b.definition.secureAlgKey),e.handshake.handleChooseSecureAlg());c=u();a.set(c.paramName,c.value);c=v();a.set(c.paramName,
c.value);e.handshake.handleSessionTo(a);a.set("r",Math.random());return Common.Util.checkEmpty("checkCaptcha.applyUri",e.safeCheck.checkCaptcha.applyUri)+"?"+Common.Util.toUrl({},a)},B=function(){var a=new Map,c=encodeURIComponent(Common.Util.getEleValue("account.principalInput",b.account.principalInput));a.set(Common.Util.checkEmpty("definition.principalKey",b.definition.principalKey),c);a.set(Common.Util.checkEmpty("definition.umidTokenKey",b.definition.umidTokenKey),e.umid.getValue());a.set(Common.Util.checkEmpty("definition.verifyTypeKey",
b.definition.verifyTypeKey),Common.Util.checkEmpty("captcha.use",b.captcha.use));a.set(Common.Util.checkEmpty("definition.responseType",b.definition.responseType),Common.Util.checkEmpty("definition.responseTypeValue",b.definition.responseTypeValue));a.set(Common.Util.checkEmpty("definition.secureAlgKey",b.definition.secureAlgKey),e.handshake.handleChooseSecureAlg());a.set("r",Math.random());c=u();a.set(c.paramName,c.value);c=v();a.set(c.paramName,c.value);e.handshake.handleSessionTo(a);return Common.Util.checkEmpty("deploy.baseUri",
b.deploy.baseUri)+Common.Util.checkEmpty("definition.verifyAnalyzeUri",b.definition.verifyAnalyzeUri)+"?"+Common.Util.toUrl({},a)},q=function(a){a?(a=encodeURIComponent(Common.Util.getEleValue("account.principalInput",b.account.principalInput,!1)),x(a,function(a){e.safeCheck.checkCaptcha.enabled&&!e.flags.isCurrentlyApplying&&Common.Util.checkEmpty("captcha.getVerifier",b.captcha.getVerifier)().captchaRender()})):Common.Util.checkEmpty("captcha.getVerifier",b.captcha.getVerifier)().captchaRender()},
D=function(a,c){if("qrcodePanel"==c){var d=r.querySelector("#iam_qrcode_panel_iframe");if(null==d||0>=d.length){d=Common.Util.checkEmpty("sns.qrcodePanel",b.sns.qrcodePanel);c=Common.Util.checkEmpty("qrcodePanel.src",d.src);var f=d.width||"250",e=d.height||"260",d=r.createElement("iframe");d.setAttribute("id","iam_qrcode_panel_iframe");d.setAttribute("frameborder","1");d.setAttribute("scrolling","no");d.setAttribute("width",f);d.setAttribute("height",e);d.setAttribute("style","border:solid 0;");c.appendChild(d)}setTimeout(function(){var b=
r.querySelector("#iam_qrcode_panel_iframe");-1==navigator.userAgent.indexOf("MSIE")?b.src=a:b.location=a},2)}else if("pagePanel"==c){c=Common.Util.checkEmpty("sns.pagePanel",b.sns.pagePanel);var k=p.open(a,p,"modal\x3d"+(c.modal||"yes")+",width\x3d"+(c.width||"800px")+",height\x3d"+(c.height||"500px")+",resizable\x3d"+(c.resizable||"no")+",left\x3d"+(c.left||"250px")+",top\x3d"+(c.top||"100px")),l=setInterval(function(){var a=p.document.getElementsByTagName("body")[0].getAttribute("refreshUrl");null!=
k&&k.closed&&(clearInterval(l),Common.Util.isEmpty(a)||(Common.Util.getRootWindow(p).location.href=a))},200)}else throw"Unsupported panelType, use 'qrcodePanel' or 'pagePanel'";},E=function(){if(b.sns.enable){var a=Common.Util.checkEmpty("sns.provider",b.sns.provider),c;for(c in a){var d=a[c],f=Common.Util.checkEmpty(c+".src",d.src),d=Common.Util.checkEmpty(c+".panelType",d.panelType);f.setAttribute("provider",c);f.setAttribute("panelType",d);f.onclick=function(a){var c=a.srcElement;a=c.getAttribute("provider");
var c=c.getAttribute("panelType"),d;d=Common.Util.checkEmpty("sns.required",b.sns.required);var f=Common.Util.checkEmpty("required.getWhich",d.getWhich(a,c));d=b.deploy.baseUri+Common.Util.checkEmpty("definition.snsConnectUri",b.definition.snsConnectUri)+Common.Util.checkEmpty("provider",a)+"?"+Common.Util.checkEmpty("definition.whichKey",b.definition.whichKey)+"\x3d"+f;if("bind"==f.toLowerCase()||"unbind"==f.toLowerCase()){var f=encodeURIComponent(Common.Util.checkEmpty("sns.principal",b.sns.getPrincipal())),
e=encodeURIComponent(Common.Util.checkEmpty("sns.required.refreshUrl",b.sns.required.refreshUrl));d+="\x26"+Common.Util.checkEmpty("definition.principalKey",b.definition.principalKey)+"\x3d"+f;d+="\x26"+Common.Util.checkEmpty("definition.refreshUrlKey",b.definition.refreshUrlKey)+"\x3d"+e}"pagePanel"==c?d+="\x26agent\x3dy":"qrcodePanel"==c&&(d+="\x26agent\x3dn");if(!b.sns.onBefore(a,c,d))return console.warn("onBefore has blocked execution"),this;D(d,c)}}}else console.debug("SNS authenticator not enable!")},
x=function(a,c){$(function(){c||(c=a,a="");if(Common.Util.checkEmpty("init.onPreCheck",b.init.onPreCheck)(a)){var d=new Map;d.set("{principalKey}",a);d.set("{verifyTypeKey}",Common.Util.checkEmpty("captcha.use",b.captcha.use));d.set("{umidTokenKey}",e.umid.getValue());d.set("{secureAlgKey}",e.handshake.handleChooseSecureAlg());n("post",!0,"{checkUri}",d,function(a){Common.Util.checkEmpty("init.onPostCheck",b.init.onPostCheck)(a);var d=Common.Util.checkEmpty("definition.codeOkValue",b.definition.codeOkValue);
Common.Util.isEmpty(a)||a.code!=d||(e.safeCheck=$.extend(!0,e.safeCheck,a.data),c(a))},function(a){console.log("Failed to safe check, "+a);Common.Util.checkEmpty("init.onError",b.init.onError)(a)},null,!0)}else console.warn("Skip the init safeCheck, because onPreCheck() return false")})},F=function(){b.captcha.enable?$(function(){q(!0);if("VerifyWithSimpleGraph"==b.captcha.use||"VerifyWithGifGraph"==b.captcha.use){var a=$(Common.Util.checkEmpty("captcha.input",b.captcha.input));a.attr("maxlength",
Common.Util.checkEmpty("captcha.getVerifier",b.captcha.getVerifier)().captchaLen);a.keyup(function(){if(e.safeCheck.checkCaptcha.enabled){var c=a.val();if(!Common.Util.isEmpty(c)&&c.length>=parseInt(a.attr("maxlength"))&&!e.flags.isVerifying){e.flags.isVerifying=!0;var d=new Map;d.put("{verifyDataKey}",c);d.put("{applyTokenKey}",Common.Util.checkEmpty("applyModel.applyToken",e.applyModel.applyToken));d.put("{verifyTypeKey}",Common.Util.checkEmpty("applyModel.verifyType",e.applyModel.verifyType));
d.set("{umidTokenKey}",e.umid.getValue());n("post",!0,B(),d,function(a){e.flags.isVerifying=!1;var c=Common.Util.checkEmpty("definition.codeOkValue",b.definition.codeOkValue);Common.Util.isEmpty(a)||a.code==c?(e.verifiedModel=a.data.verifiedModel,Common.Util.checkEmpty("captcha.getVerifier",b.captcha.getVerifier)().captchaDestroy(!1)):(q(!0),b.captcha.onError(a.message))},function(a){e.flags.isVerifying=!1;q(!0);b.captcha.onError(a)},null,!0)}}})}}):console.debug("Captcha verifier not enable!")},
H=function(){b.account.enable?$(function(){$(r).bind("keydown",function(a){13==a.keyCode&&$(Common.Util.checkEmpty("account.submitBtn",b.account.submitBtn)).click()});$(Common.Util.checkEmpty("account.submitBtn",b.account.submitBtn)).click(function(){var a=encodeURIComponent(Common.Util.getEleValue("account.principalInput",b.account.principalInput)),c=Common.Util.getEleValue("account.credentialInput",b.account.credentialInput);if(Common.Util.isAnyEmpty(a,c))b.account.onError(Common.Util.isZhCN()?
"请输入账户名和密码":"Please input your account and password");else x(a,function(d){e.clientSecretKey=IAMCrypto.RSA.generateKey();d=Common.Util.checkEmpty("Secret is required",e.safeCheck.checkGeneric.secretKey);d=encodeURIComponent(IAMCrypto.RSA.encryptToHexString(d,c));var f="";if(e.safeCheck.checkCaptcha.enabled&&(f=e.verifiedModel.verifiedToken,Common.Util.isEmpty(f))){b.account.onError(Common.Util.isZhCN()?"请完成人机验证":"Please complete man-machine verify");q(!1);return}if(Common.Util.isAnyEmpty(a,d))b.account.onError("No empty login name or password allowed");
else if(b.account.onBeforeSubmit(a,d,f)){$(Common.Util.checkEmpty("account.submitBtn",b.account.submitBtn)).attr("disabled",!0);var g=new Map;g.set("{principalKey}",a);g.set("{credentialKey}",d);g.set("{clientSecretKey}",e.clientSecretKey.publicKeyHex);g.set("{clientRefKey}",G());g.set("{verifiedTokenKey}",f);g.set("{verifyTypeKey}",Common.Util.checkEmpty("captcha.use",b.captcha.use));g.set("{secureAlgKey}",e.handshake.handleChooseSecureAlg());g.set("{umidTokenKey}",e.umid.getValue());Common.Util.mergeMap(b.account.customParamMap,
g);n("post",!0,"{accountSubmitUri}",g,function(c){$(Common.Util.checkEmpty("account.submitBtn",b.account.submitBtn)).removeAttr("disabled");e.verifiedModel.verifiedToken="";var d=Common.Util.checkEmpty("definition.codeOkValue",b.definition.codeOkValue);Common.Util.isEmpty(c)||c.code==d?($(r).unbind("keydown"),d=Common.Util.checkEmpty("Login successfully, response data.redirect_url is empty",c.data[b.definition.redirectUrlKey]),b.account.onSuccess(a,c.data)&&(Common.Util.getRootWindow(p).location.href=
d)):(q(!0),b.account.onError(c.message))},function(a){$(Common.Util.checkEmpty("account.submitBtn",b.account.submitBtn)).removeAttr("disabled");e.verifiedModel.verifiedToken="";b.account.onError(a)},null,!0)}})})}):console.debug("Account authenticator not enable!")},I=function(){b.sms.enable?$(function(){$(Common.Util.checkEmpty("sms.sendSmsBtn",b.sms.sendSmsBtn)).click(function(){var a=Common.Util.getEleValue("sms.mobileArea",b.sms.mobileArea,!1)+Common.Util.getEleValue("sms.mobile",b.sms.mobile,
!1);if(Common.Util.isEmpty(a))b.sms.onError("SMS login for mobile number is required.");else{var c=$(Common.Util.checkEmpty("captcha.input",b.captcha.input)),g=c.val();if(e.safeCheck.captchaEnabled&&(Common.Util.isEmpty(g)||g.length<c.attr("maxlength")))b.account.onError("Illegal length of captcha input");else c=new Map,c.set("{principalKey}",encodeURIComponent(a)),c.set("{verifiedTokenKey}",g),n("post",!0,"{smsApplyUri}",c,function(a){var c=Common.Util.checkEmpty("definition.codeOkValue",b.definition.codeOkValue);
if(Common.Util.isEmpty(a)||a.code==c){b.sms.onSuccess(a);var d=parseInt(a.data.checkSms.remainDelayMs/1E3),e=setInterval(function(){var a=$(b.sms.sendSmsBtn);1>d?(a.attr("disabled",!1),a.text("获取"),clearInterval(e)):(a.attr("disabled",!0),a.text(d+"s"),d--)},1E3)}else b.sms.onError(a.message)},function(a){b.sms.onError(a)},null,!0)}});$(Common.Util.checkEmpty("sms.submitBtn",b.sms.submitBtn)).click(function(){var a=Common.Util.getEleValue("sms.mobileArea",b.sms.mobileArea,!1)+Common.Util.getEleValue("sms.mobile",
b.sms.mobile,!1),c=Common.Util.getEleValue("sms.smsCode",b.sms.smsCode,!1);if(b.sms.onBeforeSubmit(a,c)){var e=new Map;e.set("{principalKey}",encodeURIComponent(a));e.set("{credentialKey}",c);e.set("{smsActionKey}",Common.Util.checkEmpty("definition.smsActionValueLogin",b.definition.smsActionValueLogin));n("post",!0,"{smsSubmitUri}",e,function(a){var c=Common.Util.checkEmpty("definition.codeOkValue",b.definition.codeOkValue);if(Common.Util.isEmpty(a)||a.code==c)b.sms.onSuccess(a),Common.Util.getRootWindow(p).location.href=
a.data.redirect_url;else b.sms.onError(a.message)},function(a){b.sms.onError(a)},null,!0)}});if(e.safeCheck.checkSms.enabled){$(b.sms.mobile).val(e.safeCheck.checkSms.mobileNum);var a=parseInt(e.safeCheck.checkSms.remainDelayMs/1E3),c=setInterval(function(){var d=$(b.sms.sendSmsBtn);if(1>a){d.attr("disabled",!1);var e="新获取验证码";Common.Util.isZhCN()||(e="Get verify code");d.text(e);clearInterval(c)}else d.attr("disabled",!0),d.text(a+"s"),a--},1E3)}}):console.debug("SMS authenticator not enable!")},
G=function(){var a=null,c=Common.Util.PlatformType,b;for(b in c)if(c[b]){console.debug("Got current OS: "+b);a=b;break}Common.Util.isEmpty(a)&&(a="Unknown",console.warn("Unknown platform browser ["+navigator.appVersion+"]"));return a},n=function(a,c,d,f,g,k,l,m){Common.Util.isMap(f)?f.set("{responseType}",Common.Util.checkEmpty("definition.responseTypeValue",b.definition.responseTypeValue)):Common.Util.isObject(f)&&(f.responseType=Common.Util.checkEmpty("definition.responseTypeValue",b.definition.responseTypeValue));
m&&e.handshake.handleSessionTo(f);m=null;d.startsWith("@")?m=d.substring(d.indexOf("@")+1):(m=Common.Util.checkEmpty("deploy.baseUri",b.deploy.baseUri),d.startsWith("{")&&d.endsWith("}")&&(d=d.substr(1,d.length-2)),m+=Common.Util.checkEmpty("definition",b.definition[d]));d=new Map;if("POST"==a.toUpperCase()||"DELETE"==a.toUpperCase()){var h=u();d.set(h.headerName,h.value);h=v();d.set(h.headerName,h.value)}f=Common.Util.isMap(f)?Common.Util.toUrl(b.definition,f):f;$.ajax({url:m,type:a,async:c,headers:JSON.fromMap(d),
data:f,xhrFields:{withCredentials:!0},success:function(a,c,b){g&&g(a)},error:function(a,c,b){k&&k(b)},complete:function(a){l&&l(a)}})},y={mutexControllerManager:new Map,doMultiModularRequest:function(a,c,b,e,g,k,l){n(a,b,"@"+c,e||{},g,k,l,!1)},checkTGCExpiredAndRedirectToLogin:function(a){console.debug("TGC validating... res: "+JSON.stringify(a));return t(a)&&"IamWithCasAppServer"==a.data.serviceRole?(console.debug("TGC expired, redirectTo: "+a.data[b.definition.redirectUrlKey]),!0):!1},getMutexController:function(a){var c=
y;a=new URL(a);a=a.protocol+"://"+a.host;var b=c.mutexControllerManager.get(a);b||c.mutexControllerManager.set(a,b={urlSame:a,currentlyState:!1,requestQueue:[],authenticated:!1});return b},doHandle:function(a,c,b,e,g,k){var d=y;Common.Util.checkEmpty("multiModularAuthenticatingRequest.res",a);Common.Util.checkEmpty("multiModularAuthenticatingRequest.method",c);Common.Util.checkEmpty("multiModularAuthenticatingRequest.url",b);if(t(a)){var f=d.getMutexController(b);if(f.currentlyState){var h={res:a,
method:c,url:b,successFn:e,errorFn:g,params:k};f.requestQueue.push(h);IAMCore.Console.info("Offered authenticating authRequest: "+h+", requestQueue: "+f.requestQueue)}else f.currentlyState=!0,(new Promise(function(b,e){IAMCore.Console.info("Biz unauth response: "+JSON.stringify(a));f.authenticated?b():d.checkTGCExpiredAndRedirectToLogin(a)||(a.data&&a.data.redirect_url?d.doMultiModularRequest(c,a.data.redirect_url,!0,null,b,g,null):g(a))})).then(function(a){IAMCore.Console.info("Iam-server response: "+
JSON.stringify(a));if(!f.authenticated&&!d.checkTGCExpiredAndRedirectToLogin(a)){if(a.data&&a.data.redirect_url)return new Promise(function(b,c){d.doMultiModularRequest("get",a.data.redirect_url,!0,null,b,g,null)});g&&g(a)}}).then(function(a){IAMCore.Console.info("Iam-client response: "+JSON.stringify(a));f.currentlyState=!1;d.doMultiModularRequest(c,b,!0,k,function(a){IAMCore.Console.info("Redirect origin biz response: "+JSON.stringify(a));t(a)?f.authenticated=!1:(e&&e(a),f.authenticated=!0)},function(a){g?
g(a):console.error(a)},function(){if(0<f.requestQueue.length){var a=f.requestQueue[0];f.requestQueue.splice(0,1);IAMCore.Console.info("Poll authenticating queue first: "+a+", requestQueue: "+f.requestQueue);d.doHandle(a.res,a.method,a.url,a.successFn,a.errorFn,a.params)}})})}else IAMCore.Console.debug("Ignore non-unauthenticated res. url: "+b+", res: "+a)}},z=function(){return e.umid.getValuePromise().then(function(a){return e.handshake.getValuePromise(a)})};p.IAMCore=function(a){e.__that=this;b=
$.extend(!0,b,a);IAMCore.Console.debug("Merged Iam core settings: "+JSON.stringify(b));Common.Util.isEmpty(b.deploy.baseUri)&&(b.deploy.baseUri=C(),IAMCore.Console.info("Used overlay iamBaseURI: "+b.deploy.baseUri));sessionStorage.setItem(h.baseUriStoredKey,b.deploy.baseUri)};IAMCore.prototype.getUMToken=function(){return runtim.umid.getValue()};IAMCore.prototype.safeCheck=function(a,b){z().then(function(c){x(a,b)});return this};IAMCore.prototype.anyAuthenticators=function(){return this.accountAuthenticator().smsAuthenticator().snsAuthenticator().captchaVerifier()};
IAMCore.prototype.accountAuthenticator=function(){b.account.enable=!0;return this};IAMCore.prototype.smsAuthenticator=function(){b.sms.enable=!0;return this};IAMCore.prototype.snsAuthenticator=function(){b.sns.enable=!0;return this};IAMCore.prototype.captchaVerifier=function(){b.captcha.enable=!0;return this};IAMCore.prototype.build=function(){z().then(function(a){H();I();E();F()})};IAMCore.prototype.destroy=function(){for(var a in h)sessionStorage.removeItem(h[a]);b=e=w=h=null;console.log("Destroyed IAMCore instance.")};
IAMCore.prototype.getXsrfToken=u;IAMCore.prototype.generateReplayToken=v;IAMCore.prototype.checkAuthenticationAndRedirect=function(a){r.write("\x3cstyle\x3ebody{display:none;}\x3c/style\x3e");return new Promise(function(b,d){z().then(function(c){if(!IAMCore.checkRespUnauthenticated(c)){sessionStorage.setItem(h.authenticatedRedirectCountStorageKey,0);c=parseInt(sessionStorage.getItem(h.authenticatedRedirectCountStorageKey)||0);if(10<c)throw Error("Too many failure redirects: "+c);sessionStorage.setItem(h.authenticatedRedirectCountStorageKey,
++c);IAMCore.Console.info("Login authenticated, redirect to: "+a);p.location=a}b();$("body").show()})})};IAMCore.Console={_isVerbose:function(){var a=sessionStorage.getItem(h.iamVerboseStoredKey);return a?(a=a.toUpperCase(),"TRUE"==a||"1"==a||"Y"==a||"YES"==a):!1},debug:function(a){IAMCore.Console._isVerbose()&&console.debug(a)},info:function(a){IAMCore.Console._isVerbose()&&console.info(a)},warn:function(a){IAMCore.Console._isVerbose()&&console.warn(a)},error:function(a){IAMCore.Console._isVerbose()&&
console.error(a)}};IAMCore.checkRespUnauthenticated=t;IAMCore.checkRespSuccess=function(a){return a.code==b.definition.code401Value||a.code+""==b.definition.code401Value?!0:!1};IAMCore.multiModularMutexAuthenticatingHandler=y.doHandle;IAMCore.getIamBaseUri=function(){var a=sessionStorage.getItem(h.baseUriStoredKey);a||sessionStorage.setItem(h.baseUriStoredKey,a=C());return a}})(window,document);