(function(p,t){var k={iamVerboseStoredKey:"__IAM_VERBOSE",baseUriStoredKey:"__IAM_BASEURI",umidTokenStorageKey:"__IAM_UMIDTOKEN",authRedirectRecordStorageKey:"__IAM_AUTHC_REDIRECT_RECORD",useSecureAlgorithmName:"RSA"},e={__that:null,umid:{_value:null,getValue:function(){return Common.Util.checkEmpty("Fatal error, umidToken value is null, No attention to call order (must be executed after runtime.umid.getValuePromise())",e.umid._value)},_currentlyInGettingValuePromise:null,getValuePromise:function(){if(e.umid._currentlyInGettingValuePromise)return e.umid._currentlyInGettingValuePromise;
var a=Common.Util.Codec.decodeBase58(sessionStorage.getItem(k.umidTokenStorageKey));return Common.Util.isEmpty(a)?e.umid._currentlyInGettingValuePromise=new Promise(function(a,d){IamFingerprint.getFingerprint({},function(b){var f=new Map;f.set("userAgent",b.components.get("userAgent"));f.set("platform",b.components.get("platform"));f.set("pixelRatio",b.components.get("pixelRatio"));f.set("timezone",b.components.get("timezone"));f.set("language",b.components.get("language"));f.set("cpuClass",b.components.get("cpuClass"));
f.set("touchSupport",b.components.get("touchSupport"));f.set("deviceMemory",b.components.get("deviceMemory"));f.set("availableScreenResolution",b.components.get("availableScreenResolution"));f.set("canvas",CryptoJS.MD5(b.components.get("canvas")).toString(CryptoJS.enc.Hex));f.set("webgl",CryptoJS.MD5(b.components.get("webgl")).toString(CryptoJS.enc.Hex));f.set("indexedDb",b.components.get("indexedDb"));f.set("sessionStorage",b.components.get("sessionStorage"));f.set("localStorage",b.components.get("localStorage"));
f.set("colorDepth",b.components.get("colorDepth"));b=new Map;for(var g=Common.Util.toUrl({},f),f=100+parseInt(100*Math.random()),n=parseInt(f%3+1),l=0;l<n;l++)g=Common.Util.Codec.encodeBase58(g);g=f+"!"+g;h.debug("Generated apply umidToken data: "+g);b.set("umdata",g);m("post","{applyUmTokenUri}",b,function(b){Common.Util.checkEmpty("init.onPostUmidToken",c.init.onPostUmidToken)(b);var d=Common.Util.checkEmpty("definition.codeOkValue",c.definition.codeOkValue);Common.Util.isEmpty(b)||b.code!=d||(h.debug("Got umidToken: "+
b.data.umidToken),d=Common.Util.Codec.encodeBase58(b.data.umidToken),sessionStorage.setItem(k.umidTokenStorageKey,d),a(b.data.umidToken),e.umid._value=b.data.umidToken);e.umid._currentlyInGettingValuePromise=null},function(a){e.umid._currentlyInGettingValuePromise=null;console.warn("Failed to gets umidToken, "+a);Common.Util.checkEmpty("init.onError",c.init.onError)(a);d(a)},null,!1)})}):(e.umid._value=a,new Promise(function(b,c){return b(a)}))}},handshake:{_value:null,getValue:function(){return Common.Util.checkEmpty("Fatal error, handshake value is null, No attention to call order (must be executed after runtime.handshake.getValuePromise())",
e.handshake._value)},_currentlyInGettingValuePromise:null,getValuePromise:function(a,b){if(!b){if(e.handshake._currentlyInGettingValuePromise)return e.handshake._currentlyInGettingValuePromise;if(!Common.Util.isEmpty(e.handshake._value))return new Promise(function(a,b){return a(e.handshake._value)})}return e.handshake._currentlyInGettingValuePromise=new Promise(function(b,g){g=new Map;g.set("{umidTokenKey}",Common.Util.checkEmpty("umidToken",a));m("post","{handshakeUri}",g,function(a){Common.Util.checkEmpty("init.onPostHandshake",
c.init.onPostHandshake)(a);var d=Common.Util.checkEmpty("definition.codeOkValue",c.definition.codeOkValue);Common.Util.isEmpty(a)||a.code!=d||(e.handshake._value=$.extend(!0,e.handshake._value,a.data),b(a));e.handshake._currentlyInGettingValuePromise=null},function(a){e.handshake._currentlyInGettingValuePromise=null;h.log("Failed to handshake, "+a);Common.Util.checkEmpty("init.onError",c.init.onError)(a)},null,!1)})},handleSessionTo:function(a){Common.Util.isAnyEmpty(e.handshake._value.session.sk,
e.handshake._value.session.sv)||(Common.Util.isObject(a)?a[e.handshake._value.session.sk]=e.handshake._value.session.sv:Common.Util.isMap(a)&&a.set(e.handshake._value.session.sk,e.handshake._value.session.sv))},handleChooseSecureAlg:function(){var a=e.handshake.getValue().algs,b;for(b in a)if(Common.Util.Codec.decodeBase58(a[b]).startsWith(k.useSecureAlgorithmName))return a[b];throw Error("No such secure algoritm of: "+k.useSecureAlgorithmName);}},safeCheck:{checkGeneric:{secretKey:null},checkCaptcha:{enabled:!1,
support:null,applyUri:null},checkSms:{enabled:!1,mobileNum:null,remainDelayMs:null}},clientSecretKey:{},applyModel:{primaryImg:null,applyToken:null,verifyType:null},verifiedModel:{verified:!0,verifiedToken:null},flags:{isCurrentlyApplying:!1,isVerifying:!1}},x={captchaLen:5,captchaDestroy:function(a){var b=Common.Util.checkEmpty("captcha.input",c.captcha.input),d=Common.Util.checkEmpty("captcha.img",c.captcha.img);$(d).unbind("click");$(d).attr({src:"./static/images/ok.png"});$(b).attr("disabled",
!0);$(b).css({cursor:"context-menu"});a&&($(b).val(""),$(b).css({display:"none"}),$(d).attr({src:""}),$(d).css({display:"none"}))},captchaRender:function(){e.flags.isCurrentlyApplying=!1;var a=$(Common.Util.checkEmpty("captcha.input",c.captcha.input)),b=Common.Util.checkEmpty("captcha.img",c.captcha.img);a.val("");$(b).click(function(){q(!0)});m("get",B(),new Map,function(d){e.flags.isCurrentlyApplying=!1;e.applyModel=d.data.applyModel;$(a).css({display:"none",cursor:"text"});$(a).removeAttr("disabled");
$(b).css({display:"none"});var g=Common.Util.checkEmpty("definition.codeOkValue",c.definition.codeOkValue);Common.Util.isEmpty(d)||d.code!=g?($(b).attr("title",d.message),$(b).unbind("click"),setTimeout(function(){$(b).click(function(){q(!0)})},15E3)):$(b).attr("src",d.data.applyModel.primaryImg)},function(a,b,f){h.error("Failed to apply captcha, "+f);Common.Util.checkEmpty("captcha.onError",c.captcha.onError)(f)},null,!0)}},c={definition:{codeOkValue:"200",code401Value:"401",statusUnauthenticatedValue:"Unauthenticated",
responseType:"response_type",responseTypeValue:"json",whichKey:"which",redirectUrlKey:"redirect_url",refreshUrlKey:"refresh_url",principalKey:"principal",credentialKey:"credential",clientSecretKey:"clientSecretKey",verifyTypeKey:"verifyType",applyTokenKey:"applyToken",verifyDataKey:"verifyData",verifiedTokenKey:"verifiedToken",clientRefKey:"client_ref",umidTokenKey:"umidToken",secureAlgKey:"alg",smsActionKey:"action",smsActionValueLogin:"login",applyUmTokenUri:"/rcm/applyumtoken",handshakeUri:"/login/handshake",
checkUri:"/login/check",captchaApplyUri:"/verify/applycaptcha",verifyAnalyzeUri:"/verify/verifyanalysis",accountSubmitUri:"/auth/generic",smsApplyUri:"/verify/applysmsverify",smsSubmitUri:"/auth/sms",snsConnectUri:"/sns/connect/",applyXsrfTokenUrlKey:"/xsrf/xtoken",xsrfTokenHeaderKey:"X-Iam-Xsrf-Token",xsrfTokenParamKey:"_xsrf",replayTokenHeaderKey:"X-Iam-Replay-Token",replayTokenParamKey:"_replayToken"},deploy:{baseUri:null,defaultTwoDomain:"iam",defaultServerPort:14040,defaultContextPath:"/iam-server"},
init:{onPostUmidToken:function(a){h.debug("onPostUmidToken... "+a)},onPostHandshake:function(a){h.debug("onPostHandshake... ",a)},onPreCheck:function(a){h.debug("onPreCheck... principal:"+a);return!0},onPostCheck:function(a){h.debug("onPostCheck... "+a)},onError:function(a){console.error("Failed to initialize... "+a)}},captcha:{enable:!1,use:"VerifyWithGifGraph",panel:null,img:null,input:null,getVerifier:function(){var a=Common.Util.checkEmpty("captcha.use",c.captcha.use),b=Common.Util.checkEmpty("captcha.registry",
c.captcha.registry),d;for(d in b)if(d==a)return b[d];throw"Illegal verifier type for '"+d+"'";},registry:{VerifyWithSimpleGraph:x,VerifyWithGifGraph:x,VerifyWithJigsawGraph:{captchaDestroy:function(a){var b=Common.Util.checkEmpty("captcha.panel",c.captcha.panel);a&&$(b).css({display:"none"})},captchaRender:function(){e.flags.isCurrentlyApplying=!1;var a=Common.Util.checkEmpty("captcha.panel",c.captcha.panel);$(a).JigsawIamCaptcha({verifyDataKey:Common.Util.checkEmpty("definition.verifyDataKey",c.definition.verifyDataKey),
getApplyCaptchaUrl:B,getVerifyAnalysisUrl:C,repeatIcon:"fa fa-redo",onSuccess:function(a){h.debug("Jigsaw captcha verify successful. verifiedToken is '"+a+"'");e.flags.isCurrentlyApplying=!1;e.verifiedModel.verifiedToken=a;Common.Util.checkEmpty("captcha.onSuccess",c.captcha.onSuccess)(a)},onFail:function(a){h.debug("Failed to jigsaw captcha verify. element \x3d\x3e "+a);e.flags.isCurrentlyApplying=!1;e.verifiedModel.verifiedToken="";Common.Util.checkEmpty("captcha.onError",c.captcha.onError)(a)}})}}},
onSuccess:function(a){h.debug("Jigsaw captcha verify successfully. verifiedToken is '"+a+"'")},onError:function(a){console.error("Failed to jigsaw captcha verify. "+a)}},account:{enable:!1,submitBtn:null,principalInput:null,credentialInput:null,customParamMap:new Map,onBeforeSubmit:function(a,b,c){h.debug("Prepare to submit login request. principal\x3d"+a+", verifiedToken\x3d"+c);return!0},onSuccess:function(a,b){h.info("Sign in successfully. "+b.principal+", "+b.redirectUrl);return!0},onError:function(a){console.error("Sign in error. "+
a)}},sms:{enable:!1,submitBtn:null,sendSmsBtn:null,mobileArea:null,mobile:null,onBeforeSubmit:function(a,b){h.log("Prepare to submit SMS login request. mobileNum\x3d"+a+", smsCode\x3d"+b);return!0},onSuccess:function(a){h.log("SMS success. "+a.message)},onError:function(a){throw"SMS login error. "+a;}},sns:{enable:!1,required:{getWhich:function(a,b){throw"Unsupported errors, please implement to support get which function";},refreshUrl:null},getPrincipal:function(){},qrcodePanel:null,pagePanel:null,
provider:null,onBefore:function(a,b,c){}}},h={_isVerbose:function(){var a=sessionStorage.getItem(k.iamVerboseStoredKey);return a?(a=a.toUpperCase(),"TRUE"==a||"1"==a||"Y"==a||"YES"==a):!1},_doLog:function(a,b){if(h._isVerbose()){var c=(new Date).format("[yyyy-MM-dd hh:mm:ss.S]")+" "+a+" --- ",g=[];g.push(c);for(var f in b)g.push(b[f]);switch(a){case "TRACE":console.trace.apply(console,g);break;case "DEBUG":console.debug.apply(console,g);break;case "INFO":console.info.apply(console,g);break;case "WARN":console.warn.apply(console,
g);break;case "ERROR":console.error.apply(console,g);break;default:console.log.apply(console,g)}}},trace:function(){h._doLog("TRACE",arguments)},debug:function(){h._doLog("DEBUG",arguments)},info:function(){h._doLog("INFO",arguments)},warn:function(){h._doLog("WARN",arguments)},error:function(){h._doLog("ERROR",arguments)},log:function(){h._doLog("INFO",arguments)}},u=function(a){if(a){var b=a.status&&a.status==c.definition.statusUnauthenticatedValue;return a.code&&(a.code==c.definition.code401Value||
a.code+""==c.definition.code401Value)||b}return!1},v=function(a){var b=Common.Util.checkEmpty("definition.xsrfTokenHeaderKey",c.definition.xsrfTokenHeaderKey),d=Common.Util.checkEmpty("definition.xsrfTokenParamKey",c.definition.xsrfTokenParamKey),g=function(a,b,c){a={headerName:a,paramName:b,value:c};h.debug("Got xsrfToken:",a);return a},f=location.hostname,e=Common.Util.extTopDomainString(f),n=f,e=f.indexOf(e);0<e&&(n=f.substring(0,e-1));var n=n.replace(".","_").toUpperCase(),l="IAM-"+n+"-XSRF-TOKEN",
r=Common.Util.getCookie(l,null);h.debug("Loaded cache xsrfTokenValue:",r,"by cookieName:",l);var k=!a;r||(h.debug("Loading new xsrf token..."),f=IAMCore.getIamBaseUri()+Common.Util.checkEmpty("definition.applyXsrfTokenUrlKey",c.definition.applyXsrfTokenUrlKey),$.ajax({url:f,type:"HEAD",async:!k,xhrFields:{withCredentials:!0},success:function(c,f,e){r=Common.Util.getCookie(l);h.info("Loaded new xsrfTokenValue:",r,"by cookieName:",l);k||a(g(b,d,r))},error:function(a,b,c){h.error("Failed to init xsrf token. "+
err)}}));if(k)return g(b,d,r)},w=function(){for(var a=(new Date).getTime(),b="",d=0;2>d;d++)b+=Math.random().toString(36).substr(2);for(var d=Common.Util.sortWithAscii(b+a),g=Common.Util.Crc16CheckSum.crc16Modbus(d),g=parseInt(g%d.length/Math.PI)+1,f=d,d=0;d<g;d++)f=CryptoJS.MD5(f).toString(CryptoJS.enc.Hex);d=JSON.stringify({n:b,t:a,s:f});a=Common.Util.checkEmpty("definition.replayTokenHeaderKey",c.definition.replayTokenHeaderKey);b=Common.Util.checkEmpty("definition.replayTokenParamKey",c.definition.replayTokenParamKey);
g=Common.Util.Codec.encodeBase58(d);h.debug("Generated replay token(plain): ",d," - ",g);return{headerName:a,paramName:b,value:g}},D=function(){var a=location.protocol,b=location.hostname,d=c.deploy.defaultServerPort,g=c.deploy.defaultTwoDomain,f=c.deploy.defaultContextPath,f=f.startsWith("/")?f:"/"+f;if(Common.Util.isIp(b)||"localhost"==b||"127.0.0.1"==b||b.endsWith(".debug")||b.endsWith(".local")||b.endsWith(".dev"))return a+"//"+b+":"+d+f;b=Common.Util.extTopDomainString(b);return a+"//"+g+"."+
b+f},B=function(){var a=new Map,b=encodeURIComponent(Common.Util.getEleValue("account.principalInput",c.account.principalInput));a.set(Common.Util.checkEmpty("definition.principalKey",c.definition.principalKey),b);a.set(Common.Util.checkEmpty("definition.umidTokenKey",c.definition.umidTokenKey),e.umid.getValue());a.set(Common.Util.checkEmpty("definition.verifyTypeKey",c.definition.verifyTypeKey),Common.Util.checkEmpty("captcha.use",c.captcha.use));a.set(Common.Util.checkEmpty("definition.responseType",
c.definition.responseType),Common.Util.checkEmpty("definition.responseTypeValue",c.definition.responseTypeValue));a.set(Common.Util.checkEmpty("definition.secureAlgKey",c.definition.secureAlgKey),e.handshake.handleChooseSecureAlg());b=v();a.set(b.paramName,b.value);b=w();a.set(b.paramName,b.value);e.handshake.handleSessionTo(a);a.set("r",Math.random());return Common.Util.checkEmpty("checkCaptcha.applyUri",e.safeCheck.checkCaptcha.applyUri)+"?"+Common.Util.toUrl({},a)},C=function(){var a=new Map,b=
encodeURIComponent(Common.Util.getEleValue("account.principalInput",c.account.principalInput));a.set(Common.Util.checkEmpty("definition.principalKey",c.definition.principalKey),b);a.set(Common.Util.checkEmpty("definition.umidTokenKey",c.definition.umidTokenKey),e.umid.getValue());a.set(Common.Util.checkEmpty("definition.verifyTypeKey",c.definition.verifyTypeKey),Common.Util.checkEmpty("captcha.use",c.captcha.use));a.set(Common.Util.checkEmpty("definition.responseType",c.definition.responseType),Common.Util.checkEmpty("definition.responseTypeValue",
c.definition.responseTypeValue));a.set(Common.Util.checkEmpty("definition.secureAlgKey",c.definition.secureAlgKey),e.handshake.handleChooseSecureAlg());a.set("r",Math.random());b=v();a.set(b.paramName,b.value);b=w();a.set(b.paramName,b.value);e.handshake.handleSessionTo(a);return Common.Util.checkEmpty("deploy.baseUri",c.deploy.baseUri)+Common.Util.checkEmpty("definition.verifyAnalyzeUri",c.definition.verifyAnalyzeUri)+"?"+Common.Util.toUrl({},a)},q=function(a){a?(a=encodeURIComponent(Common.Util.getEleValue("account.principalInput",
c.account.principalInput,!1)),y(a,function(a){e.safeCheck.checkCaptcha.enabled&&!e.flags.isCurrentlyApplying&&Common.Util.checkEmpty("captcha.getVerifier",c.captcha.getVerifier)().captchaRender()})):Common.Util.checkEmpty("captcha.getVerifier",c.captcha.getVerifier)().captchaRender()},E=function(a,b){if("qrcodePanel"==b){var d=t.querySelector("#iam_qrcode_panel_iframe");if(null==d||0>=d.length){d=Common.Util.checkEmpty("sns.qrcodePanel",c.sns.qrcodePanel);b=Common.Util.checkEmpty("qrcodePanel.src",
d.src);var g=d.width||"250",f=d.height||"260",d=t.createElement("iframe");d.setAttribute("id","iam_qrcode_panel_iframe");d.setAttribute("frameborder","1");d.setAttribute("scrolling","no");d.setAttribute("width",g);d.setAttribute("height",f);d.setAttribute("style","border:solid 0;");b.appendChild(d)}setTimeout(function(){var b=t.querySelector("#iam_qrcode_panel_iframe");-1==navigator.userAgent.indexOf("MSIE")?b.src=a:b.location=a},2)}else if("pagePanel"==b){b=Common.Util.checkEmpty("sns.pagePanel",
c.sns.pagePanel);var e=p.open(a,p,"modal\x3d"+(b.modal||"yes")+",width\x3d"+(b.width||"800px")+",height\x3d"+(b.height||"500px")+",resizable\x3d"+(b.resizable||"no")+",left\x3d"+(b.left||"250px")+",top\x3d"+(b.top||"100px")),h=setInterval(function(){var a=p.document.getElementsByTagName("body")[0].getAttribute("refreshUrl");null!=e&&e.closed&&(clearInterval(h),Common.Util.isEmpty(a)||(Common.Util.getRootWindow(p).location.href=a))},200)}else throw"Unsupported panelType, use 'qrcodePanel' or 'pagePanel'";
},F=function(){if(c.sns.enable){var a=Common.Util.checkEmpty("sns.provider",c.sns.provider),b;for(b in a){var d=a[b],g=Common.Util.checkEmpty(b+".src",d.src),d=Common.Util.checkEmpty(b+".panelType",d.panelType);g.setAttribute("provider",b);g.setAttribute("panelType",d);g.onclick=function(a){var b=a.srcElement;a=b.getAttribute("provider");var b=b.getAttribute("panelType"),d;d=Common.Util.checkEmpty("sns.required",c.sns.required);var g=Common.Util.checkEmpty("required.getWhich",d.getWhich(a,b));d=c.deploy.baseUri+
Common.Util.checkEmpty("definition.snsConnectUri",c.definition.snsConnectUri)+Common.Util.checkEmpty("provider",a)+"?"+Common.Util.checkEmpty("definition.whichKey",c.definition.whichKey)+"\x3d"+g;if("bind"==g.toLowerCase()||"unbind"==g.toLowerCase()){var g=encodeURIComponent(Common.Util.checkEmpty("sns.principal",c.sns.getPrincipal())),f=encodeURIComponent(Common.Util.checkEmpty("sns.required.refreshUrl",c.sns.required.refreshUrl));d+="\x26"+Common.Util.checkEmpty("definition.principalKey",c.definition.principalKey)+
"\x3d"+g;d+="\x26"+Common.Util.checkEmpty("definition.refreshUrlKey",c.definition.refreshUrlKey)+"\x3d"+f}"pagePanel"==b?d+="\x26agent\x3dy":"qrcodePanel"==b&&(d+="\x26agent\x3dn");if(!c.sns.onBefore(a,b,d))return console.warn("onBefore has blocked execution"),this;E(d,b)}}}else h.debug("SNS authenticator not enable!")},y=function(a,b){$(function(){b||(b=a,a="");if(Common.Util.checkEmpty("init.onPreCheck",c.init.onPreCheck)(a)){var d=new Map;d.set("{principalKey}",a);d.set("{verifyTypeKey}",Common.Util.checkEmpty("captcha.use",
c.captcha.use));d.set("{umidTokenKey}",e.umid.getValue());d.set("{secureAlgKey}",e.handshake.handleChooseSecureAlg());m("post","{checkUri}",d,function(a){Common.Util.checkEmpty("init.onPostCheck",c.init.onPostCheck)(a);var d=Common.Util.checkEmpty("definition.codeOkValue",c.definition.codeOkValue);Common.Util.isEmpty(a)||a.code!=d||(e.safeCheck=$.extend(!0,e.safeCheck,a.data),b(a))},function(a){h.log("Failed to safe check, "+a);Common.Util.checkEmpty("init.onError",c.init.onError)(a)},null,!0)}else console.warn("Skip the init safeCheck, because onPreCheck() return false")})},
G=function(){c.captcha.enable?$(function(){q(!0);if("VerifyWithSimpleGraph"==c.captcha.use||"VerifyWithGifGraph"==c.captcha.use){var a=$(Common.Util.checkEmpty("captcha.input",c.captcha.input));a.attr("maxlength",Common.Util.checkEmpty("captcha.getVerifier",c.captcha.getVerifier)().captchaLen);a.keyup(function(){if(e.safeCheck.checkCaptcha.enabled){var b=a.val();if(!Common.Util.isEmpty(b)&&b.length>=parseInt(a.attr("maxlength"))&&!e.flags.isVerifying){e.flags.isVerifying=!0;var d=new Map;d.put("{verifyDataKey}",
b);d.put("{applyTokenKey}",Common.Util.checkEmpty("applyModel.applyToken",e.applyModel.applyToken));d.put("{verifyTypeKey}",Common.Util.checkEmpty("applyModel.verifyType",e.applyModel.verifyType));d.set("{umidTokenKey}",e.umid.getValue());m("post",C(),d,function(a){e.flags.isVerifying=!1;var b=Common.Util.checkEmpty("definition.codeOkValue",c.definition.codeOkValue);Common.Util.isEmpty(a)||a.code==b?(e.verifiedModel=a.data.verifiedModel,Common.Util.checkEmpty("captcha.getVerifier",c.captcha.getVerifier)().captchaDestroy(!1)):
(q(!0),c.captcha.onError(a.message))},function(a){e.flags.isVerifying=!1;q(!0);c.captcha.onError(a)},null,!0)}}})}}):h.debug("Captcha verifier not enable!")},I=function(){c.account.enable?$(function(){$(t).bind("keydown",function(a){13==a.keyCode&&$(Common.Util.checkEmpty("account.submitBtn",c.account.submitBtn)).click()});$(Common.Util.checkEmpty("account.submitBtn",c.account.submitBtn)).click(function(){var a=encodeURIComponent(Common.Util.getEleValue("account.principalInput",c.account.principalInput)),
b=Common.Util.getEleValue("account.credentialInput",c.account.credentialInput);if(Common.Util.isAnyEmpty(a,b))c.account.onError(Common.Util.isZhCN()?"请输入账户名和密码":"Please input your account and password");else y(a,function(d){e.clientSecretKey=IAMCrypto.RSA.generateKey();d=Common.Util.checkEmpty("Secret is required",e.safeCheck.checkGeneric.secretKey);d=encodeURIComponent(IAMCrypto.RSA.encryptToHexString(d,b));var g="";if(e.safeCheck.checkCaptcha.enabled&&(g=e.verifiedModel.verifiedToken,Common.Util.isEmpty(g))){c.account.onError(Common.Util.isZhCN()?
"请完成人机验证":"Please complete man-machine verify");q(!1);return}if(Common.Util.isAnyEmpty(a,d))c.account.onError("No empty login name or password allowed");else if(c.account.onBeforeSubmit(a,d,g)){$(Common.Util.checkEmpty("account.submitBtn",c.account.submitBtn)).attr("disabled",!0);var f=new Map;f.set("{principalKey}",a);f.set("{credentialKey}",d);f.set("{clientSecretKey}",e.clientSecretKey.publicKeyHex);f.set("{clientRefKey}",H());f.set("{verifiedTokenKey}",g);f.set("{verifyTypeKey}",Common.Util.checkEmpty("captcha.use",
c.captcha.use));f.set("{secureAlgKey}",e.handshake.handleChooseSecureAlg());f.set("{umidTokenKey}",e.umid.getValue());Common.Util.mergeMap(c.account.customParamMap,f);m("post","{accountSubmitUri}",f,function(b){$(Common.Util.checkEmpty("account.submitBtn",c.account.submitBtn)).removeAttr("disabled");e.verifiedModel.verifiedToken="";var d=Common.Util.checkEmpty("definition.codeOkValue",c.definition.codeOkValue);Common.Util.isEmpty(b)||b.code==d?($(t).unbind("keydown"),d=Common.Util.checkEmpty("Login successfully, response data.redirect_url is empty",
b.data[c.definition.redirectUrlKey]),c.account.onSuccess(a,b.data)&&(Common.Util.getRootWindow(p).location.href=d)):(q(!0),c.account.onError(b.message))},function(a){$(Common.Util.checkEmpty("account.submitBtn",c.account.submitBtn)).removeAttr("disabled");e.verifiedModel.verifiedToken="";c.account.onError(a)},null,!0)}})})}):h.debug("Account authenticator not enable!")},J=function(){c.sms.enable?$(function(){$(Common.Util.checkEmpty("sms.sendSmsBtn",c.sms.sendSmsBtn)).click(function(){var a=Common.Util.getEleValue("sms.mobileArea",
c.sms.mobileArea,!1)+Common.Util.getEleValue("sms.mobile",c.sms.mobile,!1);if(Common.Util.isEmpty(a))c.sms.onError("SMS login for mobile number is required.");else{var b=$(Common.Util.checkEmpty("captcha.input",c.captcha.input)),f=b.val();if(e.safeCheck.captchaEnabled&&(Common.Util.isEmpty(f)||f.length<b.attr("maxlength")))c.account.onError("Illegal length of captcha input");else b=new Map,b.set("{principalKey}",encodeURIComponent(a)),b.set("{verifiedTokenKey}",f),m("post","{smsApplyUri}",b,function(a){var b=
Common.Util.checkEmpty("definition.codeOkValue",c.definition.codeOkValue);if(Common.Util.isEmpty(a)||a.code==b){c.sms.onSuccess(a);var d=parseInt(a.data.checkSms.remainDelayMs/1E3),f=setInterval(function(){var a=$(c.sms.sendSmsBtn);1>d?(a.attr("disabled",!1),a.text("获取"),clearInterval(f)):(a.attr("disabled",!0),a.text(d+"s"),d--)},1E3)}else c.sms.onError(a.message)},function(a){c.sms.onError(a)},null,!0)}});$(Common.Util.checkEmpty("sms.submitBtn",c.sms.submitBtn)).click(function(){var a=Common.Util.getEleValue("sms.mobileArea",
c.sms.mobileArea,!1)+Common.Util.getEleValue("sms.mobile",c.sms.mobile,!1),b=Common.Util.getEleValue("sms.smsCode",c.sms.smsCode,!1);if(c.sms.onBeforeSubmit(a,b)){var f=new Map;f.set("{principalKey}",encodeURIComponent(a));f.set("{credentialKey}",b);f.set("{smsActionKey}",Common.Util.checkEmpty("definition.smsActionValueLogin",c.definition.smsActionValueLogin));m("post","{smsSubmitUri}",f,function(a){var b=Common.Util.checkEmpty("definition.codeOkValue",c.definition.codeOkValue);if(Common.Util.isEmpty(a)||
a.code==b)c.sms.onSuccess(a),Common.Util.getRootWindow(p).location.href=a.data.redirect_url;else c.sms.onError(a.message)},function(a){c.sms.onError(a)},null,!0)}});if(e.safeCheck.checkSms.enabled){$(c.sms.mobile).val(e.safeCheck.checkSms.mobileNum);var a=parseInt(e.safeCheck.checkSms.remainDelayMs/1E3),b=setInterval(function(){var d=$(c.sms.sendSmsBtn);if(1>a){d.attr("disabled",!1);var e="新获取验证码";Common.Util.isZhCN()||(e="Get verify code");d.text(e);clearInterval(b)}else d.attr("disabled",!0),d.text(a+
"s"),a--},1E3)}}):h.debug("SMS authenticator not enable!")},H=function(){var a=null,b=Common.Util.PlatformType,c;for(c in b)if(b[c]){h.debug("Got current OS: "+c);a=c;break}Common.Util.isEmpty(a)&&(a="Unknown",console.warn("Unknown platform browser ["+navigator.appVersion+"]"));return a},m=function(a,b,d,g,f,h,k){Common.Util.isMap(d)?d.set("{responseType}",Common.Util.checkEmpty("definition.responseTypeValue",c.definition.responseTypeValue)):Common.Util.isObject(d)&&(d.responseType=Common.Util.checkEmpty("definition.responseTypeValue",
c.definition.responseTypeValue));k&&e.handshake.handleSessionTo(d);k=null;b.startsWith("@")?k=b.substring(b.indexOf("@")+1):(k=Common.Util.checkEmpty("deploy.baseUri",c.deploy.baseUri),b.startsWith("{")&&b.endsWith("}")&&(b=b.substr(1,b.length-2)),k+=Common.Util.checkEmpty("definition",c.definition[b]));b=new Map;if("POST"==a.toUpperCase()||"DELETE"==a.toUpperCase()){var l=v();b.set(l.headerName,l.value);l=w();b.set(l.headerName,l.value)}d=Common.Util.isMap(d)?Common.Util.toUrl(c.definition,d):d;
$.ajax({url:k,type:a,async:!0,headers:JSON.fromMap(b),data:d,xhrFields:{withCredentials:!0},success:function(a,b,c){g&&g(a)},error:function(a,b,c){f&&f(c)},complete:function(a){h&&h(a)}})},z={mutexControllerManager:new Map,doMultiModularRequest:function(a,b,c,e,f,h){m(a,"@"+b,c||{},e,f,h,!1)},checkTGCExpiredAndRedirectToLogin:function(a,b){h.debug("TGC validating... res: ",a);return u(a)&&a.data&&"IamWithCasAppServer"==a.data.serviceRole?(h.info("TGC expired, redirectTo: ",a.data[c.definition.redirectUrlKey]),
b(a),!0):!1},getMutexController:function(a){var b=z,c=null;a.toUpperCase().startsWith("HTTP://")?(a=new URL(a),c=a.protocol+"://"+a.host):c=location.origin+"//"+a;var e=b.mutexControllerManager.get(c);e||b.mutexControllerManager.set(c,e={_cache_auth_state:{state:!1,time:0},urlSame:c,currentlyInAuthenticatingState:!1,requestQueue:[],authenticated:function(a){var b=e._cache_auth_state;if(a)b.state=a,b.time=(new Date).getTime();else return b.state&&1E4>Math.abs((new Date).getTime()-b.time)}});return e},
doHandle:function(a,b,c,e,f,k,n){var d=z;Common.Util.checkEmpty("multiModularAuthenticatingRequest.res",a);Common.Util.checkEmpty("multiModularAuthenticatingRequest.method",b);Common.Util.checkEmpty("multiModularAuthenticatingRequest.url",c);Common.Util.checkEmpty("multiModularAuthenticatingRequest.redirectFn",n);if(u(a)){var g=d.getMutexController(c);if(g.currentlyInAuthenticatingState){var m={res:a,method:b,url:c,successFn:e,errorFn:f,params:k};g.requestQueue.push(m);h.info("Offered authenticating authRequest: ",
m,", requestQueue: ",g.requestQueue)}else g.currentlyInAuthenticatingState=!0,(new Promise(function(c,e){h.info("Biz unauth response: ",a);g.authenticated()?c():d.checkTGCExpiredAndRedirectToLogin(a,n)||(a.data&&a.data.redirect_url?d.doMultiModularRequest(b,a.data.redirect_url,!0,null,c,f,null):f(a))})).then(function(a){h.info("Iam-server response: ",a);if(!g.authenticated()&&!d.checkTGCExpiredAndRedirectToLogin(a,n)){if(a.data&&a.data.redirect_url)return new Promise(function(b,c){d.doMultiModularRequest("get",
a.data.redirect_url,!0,null,b,f,null)});f&&f(a)}}).then(function(a){h.info("Iam-client response: ",a);g.currentlyInAuthenticatingState=!1;d.doMultiModularRequest(b,c,!0,k,function(a){h.info("Redirect origin biz response: ",a);u(a)?g.authenticated(!1):(e&&e(a),g.authenticated(!0))},function(a){f?f(a):h.error(a)},function(){if(0<g.requestQueue.length){var a=g.requestQueue[0];g.requestQueue.splice(0,1);h.info("Poll authenticating queue first: ",a,", requestQueue: ",g.requestQueue);d.doHandle(a.res,a.method,
a.url,a.successFn,a.errorFn,a.params,n)}})})}else h.debug("Ignore authenticated of url: ",c,", res: ",a)}},A=function(a){return e.umid.getValuePromise().then(function(b){return e.handshake.getValuePromise(b,a)})};p.IAMCore=function(a){e.__that=this;c=$.extend(!0,c,a);h.debug("Merged iam core settings: ",c);c.deploy.baseUri=D();h.info("Use overlay iam baseUri: ",c.deploy.baseUri);sessionStorage.setItem(k.baseUriStoredKey,c.deploy.baseUri)};IAMCore.prototype.getUMToken=function(){return runtim.umid.getValue()};
IAMCore.prototype.safeCheck=function(a,b){A().then(function(c){y(a,b)});return this};IAMCore.prototype.anyAuthenticators=function(){return this.accountAuthenticator().smsAuthenticator().snsAuthenticator().captchaVerifier()};IAMCore.prototype.accountAuthenticator=function(){c.account.enable=!0;return this};IAMCore.prototype.smsAuthenticator=function(){c.sms.enable=!0;return this};IAMCore.prototype.snsAuthenticator=function(){c.sns.enable=!0;return this};IAMCore.prototype.captchaVerifier=function(){c.captcha.enable=
!0;return this};IAMCore.prototype.build=function(){h.info("IAMCore init and building ...");A(!0).then(function(a){I();J();F();G()})};IAMCore.prototype.destroy=function(){for(var a in k)sessionStorage.removeItem(k[a]);c=e=x=k=null;h.log("Destroyed IAMCore instance.")};IAMCore.prototype.getXsrfToken=v;IAMCore.prototype.generateReplayToken=w;IAMCore.prototype.checkAuthenticationAndRedirect=function(a){h.info("Hidden login document(*) ... ");$("\x3cstyle id\x3d'iam_check_authc_redirect_style'\x3e*{display:none;}\x3c/style\x3e").appendTo($("head"));
return new Promise(function(b){A(!0).then(function(c){if(IAMCore.checkRespUnauthenticated(c))h.info("Unauthentication rendering login ... "),$("#iam_check_authc_redirect_style").remove(),sessionStorage.removeItem(k.authRedirectRecordStorageKey),b(c);else{c=JSON.parse(sessionStorage.getItem(k.authRedirectRecordStorageKey));if(!c||c&&6E4<Math.abs((new Date).getTime()-c.t))sessionStorage.removeItem(k.authRedirectRecordStorageKey),c={c:0,t:(new Date).getTime()};if(5<c.c)throw"Too many failure redirections: "+
c.c;++c.c;c.t=(new Date).getTime();sessionStorage.setItem(k.authRedirectRecordStorageKey,JSON.stringify(c));h.info("Authenticated and redirection to: ",a);p.location=a}})})};IAMCore.Console=h;IAMCore.checkRespUnauthenticated=u;IAMCore.checkRespSuccess=function(a){return a.code==c.definition.code401Value||a.code+""==c.definition.code401Value?!0:!1};IAMCore.multiModularMutexAuthenticatingHandler=z.doHandle;IAMCore.getIamBaseUri=function(){var a=D();sessionStorage.setItem(k.baseUriStoredKey,a);return a}})(window,
document);